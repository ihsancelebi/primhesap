<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobil Uyumlu Satış Takip Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        window.firebaseApp = initializeApp;
    </script>
    <script type="module">
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.firebaseAuth = { getAuth, onAuthStateChanged, signInAnonymously };
    </script>
     <script type="module">
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebaseFirestore = { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Configuration ---
        // Lütfen kendi Firebase yapılandırma bilgilerinizi buraya girin.
        const firebaseConfig = {
            apiKey: "AIzaSyBcxenhaF6c9RMaRwoXeA1tuxxS-a1sA5k",
            authDomain: "pirimhesap-eb53b.firebaseapp.com",
            projectId: "pirimhesap-eb53b",
            storageBucket: "pirimhesap-eb53b.firebasestorage.app",
            messagingSenderId: "842754627809",
            appId: "1:842754627809:web:ba796f62c3a894ef29bfa0",
            measurementId: "G-B0V9ZSYDZQ"
        };
        
        // --- Firebase Initialization (v11 modular syntax) ---
        let app, db, auth;
        try {
            app = window.firebaseApp(firebaseConfig);
            db = window.firebaseFirestore.getFirestore(app);
            auth = window.firebaseAuth.getAuth(app);
        } catch (e) {
            console.error("Firebase başlatılamadı. Yapılandırmayı kontrol edin.", e);
        }
        const appId = firebaseConfig.projectId;


        // --- Helper Functions & Constants ---
        const formatCurrency = (value, currency = 'TRY') => new Intl.NumberFormat('tr-TR', { style: 'currency', currency }).format(value || 0);
        const formatDate = (dateStr) => {
            if (!dateStr) return "Geçersiz Tarih";
            const date = new Date(dateStr);
            if (isNaN(date)) return "Geçersiz Tarih";
            return date.toLocaleDateString('tr-TR');
        };
        const toInputDate = (date) => {
            if(!date) return '';
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const PAYMENT_METHOD_COLORS = { 'Nakit': '#22c55e', 'Kredi Kartı': '#3b82f6' };

        // --- Icon Component ---
        const Icon = ({ name, size = 16, className = '' }) => {
            useEffect(() => {
                if (window.lucide) {
                    lucide.createIcons();
                }
            });
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };
        
        // --- UI Components ---
        const StatCard = ({ title, value, icon, color }) => (
            <div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm flex items-center space-x-4 transition-transform hover:scale-105">
                <div className={`p-3 rounded-full ${color}`}>{icon}</div>
                <div><p className="text-sm text-gray-500">{title}</p><p className="text-xl sm:text-2xl font-bold text-gray-800">{value}</p></div>
            </div>
        );

        const Modal = ({ children, isOpen, onClose, title }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div className="bg-gray-100 rounded-2xl shadow-xl w-full max-w-lg m-4">
                        <div className="p-4 sm:p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800 transition"><Icon name="x" size={24} /></button>
                        </div>
                        <div className="p-4 sm:p-6 max-h-[75vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        const Input = ({ label, ...props }) => (
            <div><label className="block text-sm font-medium text-gray-700 mb-1">{label}</label><input {...props} className="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" /></div>
        );

        const Select = ({ label, children, ...props }) => (
            <div><label className="block text-sm font-medium text-gray-700 mb-1">{label}</label><select {...props} className="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">{children}</select></div>
        );

        const Button = ({ children, onClick, className = 'bg-blue-600 hover:bg-blue-700 text-white', type = 'button', disabled = false }) => (
            <button type={type} onClick={onClick} disabled={disabled} className={`flex justify-center items-center space-x-2 px-4 py-3 rounded-lg font-semibold transition shadow-sm ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}>{children}</button>
        );
        
        // --- Form Components ---
        const SaleForm = ({ sale, items, personnel, onSave, onCancel, usdToTryRate }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [isSuggestionsVisible, setIsSuggestionsVisible] = useState(false);
            const [formData, setFormData] = useState({ personnelId: sale?.personnelId || '', itemId: sale?.itemId || '', quantity: sale?.quantity || 1, date: sale?.date || new Date().toISOString().split('T')[0], paymentMethod: sale?.paymentMethod || 'credit_card', price: sale?.price || '' });
            
            const filteredItems = useMemo(() => items.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase())), [items, searchTerm]);
            
            useEffect(() => {
                if (sale && sale.itemId) {
                    const selectedItem = items.find(i => i.id === sale.itemId);
                    if (selectedItem) setSearchTerm(selectedItem.name);
                }
            }, [sale, items]);
            
            useEffect(() => { 
                if (formData.itemId) { 
                    const selectedItem = items.find(i => i.id === formData.itemId); 
                    if (selectedItem && sale?.itemId !== formData.itemId) { 
                        setFormData(prev => ({ ...prev, price: selectedItem.price })); 
                    } 
                } 
            }, [formData.itemId, items]);

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleSearchChange = (e) => {
                const value = e.target.value;
                setSearchTerm(value);
                setFormData(prev => ({ ...prev, itemId: '' }));
                setIsSuggestionsVisible(true);
            };
            const handleSuggestionClick = (item) => {
                setFormData(prev => ({ ...prev, itemId: item.id }));
                setSearchTerm(item.name);
                setIsSuggestionsVisible(false);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const selectedItem = items.find(i => i.id === formData.itemId); const selectedPersonnel = personnel.find(p => p.id === formData.personnelId); if (!selectedItem || !selectedPersonnel || !usdToTryRate) { alert("Lütfen personel ve ürün/hizmet seçtiğinizden emin olun."); return; }
                const quantity = parseInt(formData.quantity, 10); const salePrice = parseFloat(formData.price); const totalPrice = salePrice * quantity;
                
                // --- DEĞİŞİKLİK BAŞLANGICI: Maliyet hesaplama mantığı güncellendi ---
                let itemCostInTry;
                if (selectedItem.costType === 'percentage') {
                    // Maliyet, satış fiyatının yüzdesi olarak hesaplanır
                    itemCostInTry = salePrice * (selectedItem.cost / 100);
                } else {
                    // Sabit fiyat maliyeti (mevcut mantık)
                    itemCostInTry = selectedItem.cost; 
                    if (selectedItem.costCurrency === 'USD') { 
                        itemCostInTry = selectedItem.cost * usdToTryRate; 
                    }
                }
                // --- DEĞİŞİKLİK SONU ---

                let totalCost = itemCostInTry * quantity;
                let kdvTutari = 0;
                if (formData.paymentMethod === 'credit_card') { 
                    const creditCardCost = totalPrice * 0.22; 
                    totalCost += creditCardCost;
                    kdvTutari = totalPrice * 0.20;
                }
                const netProfit = totalPrice - totalCost; const commissionRate = selectedItem.commissionRateCash; // Sadece nakit prim oranı kullanılıyor
                const personnelCommission = netProfit * (commissionRate / 100);
                onSave({ ...formData, quantity, totalPrice, totalCost, netProfit, kdvTutari, personnelCommission, itemName: selectedItem.name, personnelName: selectedPersonnel.name });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <Select label="Personel" name="personnelId" value={formData.personnelId} onChange={handleChange} required><option value="">Personel Seçin</option>{personnel.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</Select>
                    <div className="relative">
                        <Input label="Ürün/Hizmet Ara" type="text" value={searchTerm} onChange={handleSearchChange} onBlur={() => setTimeout(() => setIsSuggestionsVisible(false), 200)} onFocus={handleSearchChange} placeholder="Aramak için yazın..." />
                        {isSuggestionsVisible && filteredItems.length > 0 && (
                            <ul className="absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg -mt-1 max-h-60 overflow-y-auto shadow-lg">
                                {filteredItems.map(item => (<li key={item.id} className="px-4 py-2 cursor-pointer hover:bg-gray-100" onMouseDown={() => handleSuggestionClick(item)}>{item.name} <span className="text-sm text-gray-500">({formatCurrency(item.price)})</span></li>))}
                            </ul>
                        )}
                    </div>
                    <Input label="Satış Fiyatı (Birim)" name="price" type="number" step="0.01" min="0" value={formData.price} onChange={handleChange} required />
                    <Select label="Ödeme Yöntemi" name="paymentMethod" value={formData.paymentMethod} onChange={handleChange} required><option value="credit_card">Kredi Kartı</option><option value="cash">Nakit</option></Select>
                    <Input label="Adet" name="quantity" type="number" min="1" value={formData.quantity} onChange={handleChange} required />
                    <Input label="Tarih" name="date" type="date" value={formData.date} onChange={handleChange} required />
                    <div className="flex justify-end space-x-3 pt-4"><Button onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-gray-800">İptal</Button><Button type="submit" disabled={!usdToTryRate || !formData.itemId}>{!usdToTryRate ? 'Kur bilgisi bekleniyor...' : 'Kaydet'}</Button></div>
                </form>
            );
        };
        const PersonnelForm = ({ person, onSave, onCancel }) => { const [name, setName] = useState(person?.name || ''); const handleSubmit = (e) => { e.preventDefault(); onSave({ name }); }; return (<form onSubmit={handleSubmit} className="space-y-4"><Input label="Personel Adı" type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Örn: Ahmet Yılmaz" required /><div className="flex justify-end space-x-3 pt-4"><Button onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-gray-800">İptal</Button><Button type="submit">Kaydet</Button></div></form>); };
        
        // --- DEĞİŞİKLİK BAŞLANGICI: ItemForm güncellendi ---
        const ItemForm = ({ item, onSave, onCancel }) => { 
            const [formData, setFormData] = useState({ 
                name: item?.name || '', 
                price: item?.price || '', 
                cost: item?.cost || '', 
                costCurrency: item?.costCurrency || 'TRY', 
                costType: item?.costType || 'fixed', // EKLENDİ: Maliyet tipini state'e ekle
                commissionRateCash: item?.commissionRateCash || 0, 
                type: item?.type || 'product' 
            }); 
            
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value })); 
            
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                onSave({ ...formData, price: parseFloat(formData.price), cost: parseFloat(formData.cost), commissionRateCash: parseFloat(formData.commissionRateCash) }); 
            }; 
            
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <Select label="Tip" name="type" value={formData.type} onChange={handleChange} required>
                        <option value="product">Ürün</option>
                        <option value="service">Hizmet</option>
                    </Select>
                    <Input label="Adı" name="name" type="text" value={formData.name} onChange={handleChange} placeholder="Örn: Laptop" required />
                    <Input label="Satış Fiyatı (Birim)" name="price" type="number" step="0.01" min="0" value={formData.price} onChange={handleChange} placeholder="Örn: 15000" required />
                    
                    {/* EKLENDİ: Maliyet girişi için yeni gruplama */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <Select label="Maliyet Türü" name="costType" value={formData.costType} onChange={handleChange} required>
                            <option value="fixed">Sabit Fiyat</option>
                            <option value="percentage">Yüzde (%)</option>
                        </Select>
                        <Input 
                            label={formData.costType === 'percentage' ? "Maliyet Yüzdesi (%)" : "Maliyet (Birim)"}
                            name="cost" 
                            type="number" 
                            step="0.01" 
                            min="0" 
                            value={formData.cost} 
                            onChange={handleChange} 
                            placeholder={formData.costType === 'percentage' ? "Örn: 70" : "Örn: 12000"} 
                            required 
                        />
                    </div>
                     {/* DEĞİŞİKLİK: Maliyet para birimi seçimi sadece 'fixed' tipinde gösterilir */}
                    {formData.costType === 'fixed' && (
                        <Select label="Maliyet Para Birimi" name="costCurrency" value={formData.costCurrency} onChange={handleChange} required>
                            <option value="TRY">TRY</option>
                            <option value="USD">USD</option>
                        </Select>
                    )}

                    <Input label="Prim Oranı (%)" name="commissionRateCash" type="number" step="0.1" min="0" max="100" value={formData.commissionRateCash} onChange={handleChange} placeholder="Örn: 12" required />
                    <div className="flex justify-end space-x-3 pt-4">
                        <Button onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-gray-800">İptal</Button>
                        <Button type="submit">Kaydet</Button>
                    </div>
                </form>
            ); 
        };
        // --- DEĞİŞİKLİK SONU ---

        const ExcelImportModal = ({ isOpen, onClose, onImport }) => {
            const [file, setFile] = useState(null); const [loading, setLoading] = useState(false); const [error, setError] = useState('');
            const handleDownloadTemplate = () => { if (typeof XLSX === 'undefined') { setError('Excel kütüphanesi henüz yüklenmedi.'); return; } const templateData = [{ name: 'Örnek Ürün', type: 'product', price: 3500, cost: 2000, costCurrency: 'TRY', commissionRateCash: 15 }]; const ws = XLSX.utils.json_to_sheet(templateData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Sablon'); XLSX.writeFile(wb, 'Urun_Hizmet_Sablonu.xlsx'); };
            const handleFileChange = (e) => { setFile(e.target.files[0]); setError(''); };
            const handleImport = () => { if (!file) { setError('Lütfen bir dosya seçin.'); return; } if (typeof XLSX === 'undefined') { setError('Excel kütüphanesi yüklenemedi.'); return; } setLoading(true); setError(''); const reader = new FileReader(); reader.onload = async (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; await onImport(XLSX.utils.sheet_to_json(worksheet)); onClose(); } catch (err) { setError(err.message || 'Dosya işlenemedi.'); } finally { setLoading(false); } }; reader.onerror = () => { setError('Dosya okunurken hata.'); setLoading(false); }; reader.readAsArrayBuffer(file); };
            return (<Modal isOpen={isOpen} onClose={onClose} title="Excel'den Yükle"><div className="space-y-4"><div className="p-4 border border-blue-200 bg-blue-50 rounded-lg text-sm text-blue-800"><p className="font-semibold">Adım 1: Şablonu İndirin</p><p>Sütunlar: name, type, price, cost, costCurrency, commissionRateCash</p></div><Button onClick={handleDownloadTemplate} className="bg-gray-600 hover:bg-gray-700 text-white"><Icon name="download" size={18} /><span>Şablonu İndir</span></Button><hr /><div className="p-4 border border-green-200 bg-green-50 rounded-lg text-sm text-green-800"><p className="font-semibold">Adım 2: Dosyanızı Yükleyin</p><p>Hazırladığınız Excel dosyasını seçip "Yükle" butonuna tıklayın.</p></div><Input type="file" onChange={handleFileChange} accept=".xlsx, .xls" />{error && <p className="text-red-600 text-sm">{error}</p>}<Button onClick={handleImport} disabled={loading || !file}>{loading ? <><div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> Yükleniyor...</> : <><Icon name="upload" size={18}/> Yükle</>}</Button></div></Modal>);
        };
        
        // Chart.js Wrapper Component
        const ChartComponent = ({ type, data, options }) => {
            const chartRef = useRef(null); const chartInstance = useRef(null);
            useEffect(() => { if (chartInstance.current) { chartInstance.current.destroy(); } if (chartRef.current) { const ctx = chartRef.current.getContext('2d'); chartInstance.current = new Chart(ctx, { type, data, options }); } return () => { if (chartInstance.current) { chartInstance.current.destroy(); } }; }, [data, options, type]);
            return <div className="chart-container"><canvas ref={chartRef}></canvas></div>;
        };

        // --- View Components ---
        const Dashboard = ({ allSales, personnel }) => {
            const [filter, setFilter] = useState('this_month');
            const [customDates, setCustomDates] = useState({ start: toInputDate(new Date()), end: toInputDate(new Date()) });
            const sales = useMemo(() => { if (filter === 'all_time') return allSales; let startDate, endDate; const now = new Date(); if (filter === 'this_week') { const firstDayOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1))); firstDayOfWeek.setHours(0, 0, 0, 0); startDate = firstDayOfWeek; endDate = new Date(); } else if (filter === 'last_week') { const lastSunday = new Date(now.setDate(now.getDate() - now.getDay() - 7)); lastSunday.setHours(23, 59, 59, 999); endDate = lastSunday; const lastMonday = new Date(now.setDate(now.getDate() - 6)); lastMonday.setHours(0, 0, 0, 0); startDate = lastMonday; } else if (filter === 'this_month') { startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0); } else if (filter === 'last_month') { startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1); endDate = new Date(now.getFullYear(), now.getMonth(), 0); } else if (filter === 'custom' && customDates.start && customDates.end) { startDate = new Date(customDates.start); startDate.setHours(0,0,0,0); endDate = new Date(customDates.end); endDate.setHours(23,59,59,999); } else { return allSales; } return allSales.filter(sale => { const saleDate = new Date(sale.date); return saleDate >= startDate && saleDate <= endDate; }); }, [allSales, filter, customDates]);
            
            const totalRevenue = useMemo(() => sales.reduce((sum, sale) => sum + sale.totalPrice, 0), [sales]); const totalNetProfit = useMemo(() => sales.reduce((sum, sale) => sum + sale.netProfit, 0), [sales]); const totalCommission = useMemo(() => sales.reduce((sum, sale) => sum + sale.personnelCommission, 0), [sales]); const totalKDV = useMemo(() => sales.reduce((sum, sale) => sum + (sale.kdvTutari || 0), 0), [sales]);
            const commissionByPersonnel = useMemo(() => { const data = personnel.map(p => ({ name: p.name, value: sales.filter(s => s.personnelId === p.id).reduce((sum, s) => sum + s.personnelCommission, 0) })); return data.filter(d => d.value > 0).sort((a, b) => b.value - a.value); }, [sales, personnel]);
            const paymentMethodDistribution = useMemo(() => { const data = sales.reduce((acc, sale) => { const method = sale.paymentMethod === 'cash' ? 'Nakit' : 'Kredi Kartı'; acc[method] = (acc[method] || 0) + sale.totalPrice; return acc; }, {}); return Object.entries(data).map(([name, value]) => ({ name, value })); }, [sales]);
            const lineChartData = useMemo(() => { const data = {}; sales.forEach(sale => { const month = new Date(sale.date).toLocaleString('tr-TR', { month: 'short', year: 'numeric' }); if (!data[month]) { data[month] = { Ciro: 0, "Net Kâr": 0 }; } data[month].Ciro += sale.totalPrice; data[month]["Net Kâr"] += sale.netProfit; }); const sortedMonths = Object.keys(data).sort((a, b) => { const [monthA, yearA] = a.split(' '); const [monthB, yearB] = b.split(' '); const monthMap = { 'Oca': 0, 'Şub': 1, 'Mar': 2, 'Nis': 3, 'May': 4, 'Haz': 5, 'Tem': 6, 'Ağu': 7, 'Eyl': 8, 'Eki': 9, 'Kas': 10, 'Ara': 11 }; return new Date(yearA, monthMap[monthA]) - new Date(yearB, monthMap[monthB]); }); return { labels: sortedMonths, datasets: [ { label: 'Ciro', data: sortedMonths.map(m => data[m].Ciro), borderColor: '#8884d8', backgroundColor: 'rgba(136, 132, 216, 0.2)', fill: true, tension: 0.3 }, { label: 'Net Kâr', data: sortedMonths.map(m => data[m]["Net Kâr"]), borderColor: '#82ca9d', backgroundColor: 'rgba(130, 202, 157, 0.2)', fill: true, tension: 0.3 } ] }; }, [sales]);
            const pieChartData = { labels: paymentMethodDistribution.map(d => d.name), datasets: [{ data: paymentMethodDistribution.map(d => d.value), backgroundColor: paymentMethodDistribution.map(d => PAYMENT_METHOD_COLORS[d.name]) }] };
            const barChartData = { labels: commissionByPersonnel.map(d => d.name), datasets: [{ label: 'Kazanılan Prim', data: commissionByPersonnel.map(d => d.value), backgroundColor: '#ffc658' }] };
            const FilterButton = ({ value, label }) => (<button onClick={() => setFilter(value)} className={`px-3 py-2 rounded-lg transition text-sm font-semibold ${filter === value ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-700 hover:bg-gray-100'}`}>{label}</button>);

            return (<div className="space-y-6">
                <div className="bg-white p-4 rounded-xl shadow-sm flex flex-col sm:flex-row sm:items-center sm:flex-wrap gap-4">
                    <div className="flex items-center gap-2 flex-wrap">
                        <FilterButton value="this_week" label="Bu Hafta" />
                        <FilterButton value="last_week" label="Geçen Hafta" />
                        <FilterButton value="this_month" label="Bu Ay" />
                        <FilterButton value="last_month" label="Geçen Ay" />
                        <FilterButton value="all_time" label="Tümü" />
                        <FilterButton value="custom" label="Özel" />
                    </div>
                    {filter === 'custom' && (<div className="flex flex-col sm:flex-row items-center gap-2 border-t sm:border-t-0 sm:border-l pt-2 sm:pt-0 mt-2 sm:mt-0 sm:pl-4"><Input type="date" value={customDates.start} onChange={e => setCustomDates(d => ({ ...d, start: e.target.value }))} /><Input type="date" value={customDates.end} onChange={e => setCustomDates(d => ({ ...d, end: e.target.value }))} /></div>)}
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><StatCard title="Toplam Ciro" value={formatCurrency(totalRevenue)} icon={<Icon name="dollar-sign" className="text-white"/>} color="bg-blue-500" /><StatCard title="Toplam Net Kâr" value={formatCurrency(totalNetProfit)} icon={<Icon name="trending-up" className="text-white"/>} color="bg-green-500" /><StatCard title="Toplam Prim" value={formatCurrency(totalCommission)} icon={<Icon name="award" className="text-white"/>} color="bg-amber-500" /><StatCard title="Toplam KDV" value={formatCurrency(totalKDV)} icon={<Icon name="percent" className="text-white"/>} color="bg-red-500" /></div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm"><h3 className="text-lg font-semibold text-gray-800 mb-4">Aylık Finansal Trend</h3><ChartComponent type='line' data={lineChartData} options={{ responsive: true, maintainAspectRatio: false }} /></div><div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm"><h3 className="text-lg font-semibold text-gray-800 mb-4">Ödeme Yöntemi Dağılımı</h3><ChartComponent type='pie' data={pieChartData} options={{ responsive: true, maintainAspectRatio: false }} /></div><div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm lg:col-span-2"><h3 className="text-lg font-semibold text-gray-800 mb-4">Personele Göre Prim Dağılımı</h3><ChartComponent type='bar' data={barChartData} options={{ responsive: true, maintainAspectRatio: false }} /></div></div>
            </div>);
        };
        const PersonnelDetailView = ({ personnel, allSales, onBack }) => {
            const [filter, setFilter] = useState('this_month');
            const [customDates, setCustomDates] = useState({ start: toInputDate(new Date()), end: toInputDate(new Date()) });
            const filteredSales = useMemo(() => { const personSales = allSales.filter(s => s.personnelId === personnel.id); if (filter === 'all_time') return personSales; let startDate, endDate; const now = new Date(); if (filter === 'this_week') { const firstDayOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1))); firstDayOfWeek.setHours(0, 0, 0, 0); startDate = firstDayOfWeek; endDate = new Date(); } else if (filter === 'last_week') { const lastSunday = new Date(now.setDate(now.getDate() - now.getDay() - 7)); lastSunday.setHours(23, 59, 59, 999); endDate = lastSunday; const lastMonday = new Date(now.setDate(now.getDate() - 6)); lastMonday.setHours(0, 0, 0, 0); startDate = lastMonday; } else if (filter === 'this_month') { startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0); } else if (filter === 'last_month') { startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1); endDate = new Date(now.getFullYear(), now.getMonth(), 0); } else if (filter === 'custom' && customDates.start && customDates.end) { startDate = new Date(customDates.start); startDate.setHours(0,0,0,0); endDate = new Date(customDates.end); endDate.setHours(23,59,59,999); } else { return personSales; } return personSales.filter(sale => { const saleDate = new Date(sale.date); return saleDate >= startDate && saleDate <= endDate; }); }, [personnel, allSales, filter, customDates]);
            const stats = useMemo(() => ({ totalRevenue: filteredSales.reduce((s, a) => s + a.totalPrice, 0), totalNetProfit: filteredSales.reduce((s, a) => s + a.netProfit, 0), totalCommission: filteredSales.reduce((s, a) => s + a.personnelCommission, 0), totalSalesCount: filteredSales.length }), [filteredSales]);
            const FilterButton = ({ value, label }) => (<button onClick={() => setFilter(value)} className={`px-3 py-2 rounded-lg transition text-sm font-semibold ${filter === value ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-700 hover:bg-gray-100'}`}>{label}</button>);
            return (<div className="space-y-6"><div className="flex justify-between items-center"><Button onClick={onBack} className="w-auto bg-gray-200 hover:bg-gray-300 text-gray-800"><Icon name="arrow-left" size={20}/> Geri Dön</Button><h2 className="text-xl md:text-2xl font-bold text-gray-800 text-right">{personnel.name} Performansı</h2></div><div className="bg-white p-4 rounded-xl shadow-sm flex flex-col sm:flex-row sm:items-center sm:flex-wrap gap-4"><div className="flex items-center gap-2 flex-wrap"><FilterButton value="this_week" label="Bu Hafta" /><FilterButton value="last_week" label="Geçen Hafta" /><FilterButton value="this_month" label="Bu Ay" /><FilterButton value="last_month" label="Geçen Ay" /><FilterButton value="all_time" label="Tümü" /><FilterButton value="custom" label="Özel" /></div>{filter === 'custom' && (<div className="flex flex-col sm:flex-row items-center gap-2 border-t sm:border-t-0 sm:border-l mt-2 pt-2 sm:mt-0 sm:pt-0 sm:pl-4"><Input type="date" value={customDates.start} onChange={e => setCustomDates(d => ({ ...d, start: e.target.value }))} /><Input type="date" value={customDates.end} onChange={e => setCustomDates(d => ({ ...d, end: e.target.value }))} /></div>)}</div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><StatCard title="Toplam Satış (Ciro)" value={formatCurrency(stats.totalRevenue)} icon={<Icon name="dollar-sign" className="text-white" />} color="bg-blue-500" /><StatCard title="Toplam Net Kâr" value={formatCurrency(stats.totalNetProfit)} icon={<Icon name="trending-up" className="text-white" />} color="bg-green-500" /><StatCard title="Toplam Prim" value={formatCurrency(stats.totalCommission)} icon={<Icon name="award" className="text-white" />} color="bg-amber-500" /><StatCard title="Toplam İşlem" value={stats.totalSalesCount} icon={<Icon name="briefcase" className="text-white" />} color="bg-indigo-500" /></div><DataTable columns={[{ key: 'date', header: 'Tarih', render: (date) => formatDate(date), sortable: true }, { key: 'itemName', header: 'Ürün/Hizmet', sortable: true }, { key: 'totalPrice', header: 'Tutar', render: (price) => formatCurrency(price), sortable: true }, { key: 'netProfit', header: 'Net Kâr', render: (profit) => formatCurrency(profit), sortable: true }, { key: 'personnelCommission', header: 'Kazanılan Prim', render: (comm) => formatCurrency(comm), sortable: true }]} data={filteredSales} hideActions /></div>);
        }
        const DataTable = ({ columns, data, onEdit, onDelete, onViewDetails, onAddItem, addItemLabel, onImport, hideActions = false }) => {
            const [sortConfig, setSortConfig] = useState(null);
            const sortedData = useMemo(() => { let sortableItems = [...data]; if (sortConfig !== null) { sortableItems.sort((a, b) => { const valA = a[sortConfig.key] || ''; const valB = b[sortConfig.key] || ''; if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1; if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1; return 0; }); } return sortableItems; }, [data, sortConfig]);
            const requestSort = (key) => { let direction = 'ascending'; if (sortConfig && sortConfig.key === key && sortConfig.direction === 'ascending') { direction = 'descending'; } setSortConfig({ key, direction }); };
            return (<div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm"><div className="flex flex-col sm:flex-row justify-end mb-4 space-y-2 sm:space-y-0 sm:space-x-3">{onImport && (<Button onClick={onImport} className="bg-green-600 hover:bg-green-700 text-white"><Icon name="upload" size={18}/><span>Excel'den Yükle</span></Button>)}{onAddItem && (<Button onClick={onAddItem} className="w-full sm:w-auto"><Icon name="plus" size={18}/><span>{addItemLabel}</span></Button>)}</div><div className="overflow-x-auto"><table className="w-full text-left"><thead><tr className="border-b border-gray-200">{columns.map(col => (<th key={col.key} className="p-2 md:p-4 text-sm font-semibold text-gray-600 cursor-pointer whitespace-nowrap" onClick={() => col.sortable && requestSort(col.key)}><div className="flex items-center">{col.header}{col.sortable && sortConfig?.key === col.key && (sortConfig.direction === 'ascending' ? <Icon name="chevron-up" size={16} /> : <Icon name="chevron-down" size={16} />)}</div></th>))}{!hideActions && <th className="p-2 md:p-4 text-sm font-semibold text-gray-600">İşlemler</th>}</tr></thead><tbody>{sortedData.map(item => (<tr key={item.id} className="border-b border-gray-100 hover:bg-gray-50">{columns.map(col => (<td key={col.key} className="p-2 md:p-4 text-gray-700 whitespace-nowrap">{col.render ? col.render(item[col.key], item) : item[col.key]}</td>))}{!hideActions && <td className="p-2 md:p-4"><div className="flex space-x-3">{onViewDetails && <button onClick={() => onViewDetails(item.id)} className="text-green-600 hover:text-green-800" title="Detayları Gör"><Icon name="eye" size={18} /></button>}{onEdit && <button onClick={() => onEdit(item)} className="text-blue-600 hover:text-blue-800" title="Düzenle"><Icon name="edit" size={18} /></button>}{onDelete && <button onClick={() => onDelete(item.id)} className="text-red-600 hover:text-red-800" title="Sil"><Icon name="trash-2" size={18} /></button>}</div></td>}</tr>))}</tbody></table></div>{sortedData.length === 0 && <p className="text-center text-gray-500 py-8">Gösterilecek veri bulunamadı.</p>}</div>);
        };

        // --- App Component (Main Logic) ---
        const App = () => {
            const [userId, setUserId] = useState(null); const [isAuthReady, setIsAuthReady] = useState(false); const [view, setView] = useState('dashboard'); const [sales, setSales] = useState([]); const [items, setItems] = useState([]); const [personnel, setPersonnel] = useState([]); const [isSaleModalOpen, setSaleModalOpen] = useState(false); const [isItemModalOpen, setItemModalOpen] = useState(false); const [isPersonnelModalOpen, setPersonnelModalOpen] = useState(false); const [isImportModalOpen, setImportModalOpen] = useState(false); const [editingSale, setEditingSale] = useState(null); const [editingItem, setEditingItem] = useState(null); const [editingPersonnel, setEditingPersonnel] = useState(null); const [selectedPersonnelId, setSelectedPersonnelId] = useState(null); const [usdToTryRate, setUsdToTryRate] = useState(null);
            const [isSidebarOpen, setSidebarOpen] = useState(false); // State for mobile sidebar

            useEffect(() => { if (window.lucide) { lucide.createIcons(); } }, [view, isSaleModalOpen, isItemModalOpen, isPersonnelModalOpen, isImportModalOpen, isSidebarOpen, items, sales, personnel]);
            useEffect(() => { fetch('https://api.exchangerate-api.com/v4/latest/USD').then(response => response.json()).then(data => setUsdToTryRate(data.rates.TRY)).catch(error => { console.error(error); setUsdToTryRate(32.0); }); }, []);
            useEffect(() => { if(!auth) return; const unsubscribe = window.firebaseAuth.onAuthStateChanged(auth, (user) => { if (user) { setUserId(user.uid); } else { window.firebaseAuth.signInAnonymously(auth).catch(err => console.error(err)); } setIsAuthReady(true); }); return () => unsubscribe(); }, []);
            useEffect(() => { if (!isAuthReady || !userId || !db) return; const { collection, onSnapshot } = window.firebaseFirestore; const unsubSales = onSnapshot(collection(db, 'sales'), (s) => setSales(s.docs.map(d => ({ id: d.id, ...d.data() })))); const unsubItems = onSnapshot(collection(db, 'items'), (s) => setItems(s.docs.map(d => ({ id: d.id, ...d.data() })))); const unsubPersonnel = onSnapshot(collection(db, 'personnel'), (s) => setPersonnel(s.docs.map(d => ({ id: d.id, ...d.data() })))); return () => { unsubSales(); unsubItems(); unsubPersonnel(); }; }, [isAuthReady, userId]);
            
            const handleSave = async (collectionName, data, id) => { try { const { collection, doc, updateDoc, addDoc } = window.firebaseFirestore; if (id) await updateDoc(doc(db, collectionName, id), data); else await addDoc(collection(db, collectionName), data); } catch (e) { console.error(e); } setSaleModalOpen(false); setItemModalOpen(false); setPersonnelModalOpen(false); setEditingSale(null); setEditingItem(null); setEditingPersonnel(null); };
            const handleBulkImport = async (importedItems) => { const { writeBatch, collection, doc } = window.firebaseFirestore; const batch = writeBatch(db); if (!importedItems || importedItems.length === 0) throw new Error("Dosya boş."); importedItems.forEach(item => { const price = parseFloat(item.price); const cost = parseFloat(item.cost); const cashRate = parseFloat(item.commissionRateCash); const newItem = { name: String(item.name || '').trim(), type: String(item.type || 'product').toLowerCase(), price: isNaN(price) ? 0 : price, cost: isNaN(cost) ? 0 : cost, costCurrency: ['TRY', 'USD'].includes(String(item.costCurrency || '').toUpperCase()) ? String(item.costCurrency).toUpperCase() : 'TRY', commissionRateCash: isNaN(cashRate) ? 0 : cashRate }; if (newItem.name) { const newDocRef = doc(collection(db, 'items')); batch.set(newDocRef, newItem); } }); try { await batch.commit(); } catch (e) { console.error(e); throw new Error("Yazma izni reddedildi. Firebase kurallarını kontrol edin."); } };
            const handleDelete = async (collectionName, id) => { if (window.confirm("Bu kaydı silmek istediğinizden emin misiniz?")) { try { await window.firebaseFirestore.deleteDoc(window.firebaseFirestore.doc(db, collectionName, id)); } catch (e) { console.error(e); } } };
            const openModal = (type, item = null) => { switch (type) { case 'sale': setEditingSale(item); setSaleModalOpen(true); break; case 'item': setEditingItem(item); setItemModalOpen(true); break; case 'personnel': setEditingPersonnel(item); setPersonnelModalOpen(true); break; case 'import': setImportModalOpen(true); break; } };
            const handleViewChange = (newView) => {
                setView(newView);
                setSelectedPersonnelId(null);
                setSidebarOpen(false); // Close sidebar on navigation
            };

            const renderView = () => {
                const paymentMethodRender = (method) => (method === 'cash' ? <span className="flex items-center"><Icon name="banknote" size={16} className="mr-2 text-green-600"/>Nakit</span> : <span className="flex items-center"><Icon name="credit-card" size={16} className="mr-2 text-blue-600"/>Kredi Kartı</span>);
                
                // --- DEĞİŞİKLİK BAŞLANGICI: costRender güncellendi ---
                const costRender = (cost, item) => {
                    if (item.costType === 'percentage') {
                        return `${cost}%`;
                    }
                    return item.costCurrency === 'USD' ? `${formatCurrency(cost, 'USD')}` : `${formatCurrency(cost, 'TRY')}`;
                };
                // --- DEĞİŞİKLİK SONU ---

                const formatCurrencyCell = (value) => formatCurrency(value);
                switch (view) {
                    case 'dashboard': return <Dashboard allSales={sales} personnel={personnel} />;
                    case 'sales': return <DataTable columns={[{ key: 'date', header: 'Tarih', render: formatDate, sortable: true }, { key: 'itemName', header: 'Ürün/Hizmet', sortable: true }, { key: 'personnelName', header: 'Personel', sortable: true }, { key: 'paymentMethod', header: 'Ödeme', render: paymentMethodRender, sortable: true }, { key: 'totalPrice', header: 'Tutar', render: formatCurrencyCell, sortable: true }, { key: 'netProfit', header: 'Net Kâr', render: formatCurrencyCell, sortable: true }, { key: 'personnelCommission', header: 'Prim', render: formatCurrencyCell, sortable: true }, { key: 'kdvTutari', header: 'KDV', render: (kdv) => kdv ? formatCurrencyCell(kdv) : '-', sortable: true }]} data={sales} onEdit={(item) => openModal('sale', item)} onDelete={(id) => handleDelete('sales', id)} onAddItem={() => openModal('sale')} addItemLabel="Yeni Satış Ekle" />;
                    case 'personnel': if (selectedPersonnelId) { const person = personnel.find(p => p.id === selectedPersonnelId); return <PersonnelDetailView personnel={person} allSales={sales} onBack={() => setSelectedPersonnelId(null)} />; } return <DataTable columns={[{ key: 'name', header: 'Personel Adı', sortable: true }]} data={personnel} onViewDetails={(id) => setSelectedPersonnelId(id)} onEdit={(item) => openModal('personnel', item)} onDelete={(id) => handleDelete('personnel', id)} onAddItem={() => openModal('personnel')} addItemLabel="Yeni Personel Ekle" />;
                    case 'items': return <DataTable columns={[{ key: 'name', header: 'Adı', sortable: true }, { key: 'type', header: 'Tip', render: (t) => t === 'service' ? 'Hizmet' : 'Ürün', sortable: true }, { key: 'price', header: 'Satış Fiyatı', render: formatCurrencyCell, sortable: true }, { key: 'cost', header: 'Maliyet', render: costRender, sortable: true}, { key: 'commissionRateCash', header: 'Prim Oranı (%)', render: (r) => `${r}%`, sortable: true }]} data={items} onEdit={(item) => openModal('item', item)} onDelete={(id) => handleDelete('items', id)} onAddItem={() => openModal('item')} addItemLabel="Yeni Ürün/Hizmet" onImport={() => openModal('import')} />;
                    default: return <Dashboard allSales={sales} personnel={personnel} />;
                }
            };
            const NavItem = ({ children, onClick, isActive }) => (<button onClick={onClick} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left transition ${isActive ? 'bg-blue-600 text-white font-semibold shadow' : 'text-gray-600 hover:bg-gray-200'}`}>{children}</button>);
            
            if (!isAuthReady) { return <div className="flex h-screen items-center justify-center bg-gray-100"><div className="text-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div><p className="text-lg mt-4">Uygulama Yükleniyor...</p></div></div>; }
            
            return (
                <div className="relative min-h-screen md:flex bg-gray-100 font-sans">
                    {/* Overlay for mobile */}
                    {isSidebarOpen && <div className="fixed inset-0 bg-black opacity-50 z-20 md:hidden" onClick={() => setSidebarOpen(false)}></div>}
                    
                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 bg-white p-6 w-64 flex-shrink-0 flex flex-col justify-between shadow-lg z-30 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-transform duration-300 ease-in-out`}>
                        <div>
                            <div className="flex justify-between items-center mb-8">
                                <h1 className="text-2xl font-bold text-blue-600">Satış Paneli</h1>
                                <button className="md:hidden text-gray-500 hover:text-gray-800" onClick={() => setSidebarOpen(false)}>
                                    <Icon name="x" size={24} />
                                </button>
                            </div>
                            <nav className="space-y-3">
                                <NavItem onClick={() => handleViewChange('dashboard')} isActive={view === 'dashboard'}><Icon name="layout-dashboard" size={20}/><span>Gösterge Paneli</span></NavItem>
                                <NavItem onClick={() => handleViewChange('sales')} isActive={view === 'sales'}><Icon name="dollar-sign" size={20}/><span>Satışlar</span></NavItem>
                                <NavItem onClick={() => handleViewChange('personnel')} isActive={view === 'personnel'}><Icon name="users" size={20}/><span>Personel</span></NavItem>
                                <NavItem onClick={() => handleViewChange('items')} isActive={view === 'items'}><Icon name="package" size={20}/><span>Ürünler & Hizmetler</span></NavItem>
                            </nav>
                        </div>
                        <div className="text-center text-xs text-gray-400">
                            <p>Proje ID:</p><p className="break-words font-mono text-gray-500">{appId}</p>
                            <p className="mt-2 font-semibold text-green-600">USD/TRY: {usdToTryRate || 'Yükleniyor...'}</p>
                        </div>
                    </aside>

                    {/* Main content */}
                    <div className="flex-1 flex flex-col">
                         {/* Header with hamburger menu for mobile */}
                        <header className="md:hidden sticky top-0 bg-white/80 backdrop-blur-sm z-10 flex justify-between items-center p-4 shadow-sm">
                            <button onClick={() => setSidebarOpen(true)} className="text-gray-700">
                                <Icon name="menu" size={24} />
                            </button>
                            <h2 className="font-bold text-lg text-blue-600">
                                {view.charAt(0).toUpperCase() + view.slice(1)}
                            </h2>
                             <div className="w-6"></div> {/* Spacer */}
                        </header>
                        <main className="flex-1 p-4 md:p-8 overflow-y-auto">
                            {renderView()}
                        </main>
                    </div>

                    {/* Modals */}
                    <ExcelImportModal isOpen={isImportModalOpen} onClose={() => setImportModalOpen(false)} onImport={handleBulkImport} />
                    <Modal isOpen={isSaleModalOpen} onClose={() => setSaleModalOpen(false)} title={editingSale ? "Satış Düzenle" : "Yeni Satış Ekle"}><SaleForm sale={editingSale} items={items} personnel={personnel} onSave={(data) => handleSave('sales', data, editingSale?.id)} onCancel={() => { setSaleModalOpen(false); setEditingSale(null); }} usdToTryRate={usdToTryRate} /></Modal>
                    <Modal isOpen={isItemModalOpen} onClose={() => setItemModalOpen(false)} title={editingItem ? "Düzenle" : "Yeni Ürün/Hizmet Ekle"}><ItemForm item={editingItem} onSave={(data) => handleSave('items', data, editingItem?.id)} onCancel={() => { setItemModalOpen(false); setEditingItem(null); }} /></Modal>
                    <Modal isOpen={isPersonnelModalOpen} onClose={() => setPersonnelModalOpen(false)} title={editingPersonnel ? "Personel Düzenle" : "Yeni Personel Ekle"}><PersonnelForm person={editingPersonnel} onSave={(data) => handleSave('personnel', data, editingPersonnel?.id)} onCancel={() => { setEditingPersonnel(null); setPersonnelModalOpen(false);}} /></Modal>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
