I have modified the code for you. The following changes have been made to the "Sales" page:

1.  **Date Filters Added**: You can now filter sales records by "This Week," "Last Week," "This Month," "Last Month," "All Time," or a "Custom" date range, just like on the dashboard.
2.  **"Net Profit" Changed to "Cost"**: The sales table column that previously showed "Net Kâr" (Net Profit) now displays "Maliyet" (Total Cost) for each transaction.
3.  **Export Filtered Results**: An "Export to Excel" button has been added. Clicking this button will download an `.xlsx` file containing only the sales data that matches your current filter selection.

Below is the complete, updated HTML code. You can replace your existing code with this to apply the changes.

```html
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobil Uyumlu Satış Takip Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        window.firebaseApp = initializeApp;
    </script>
    <script type="module">
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.firebaseAuth = { getAuth, onAuthStateChanged, signInAnonymously };
    </script>
     <script type="module">
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebaseFirestore = { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            // Your Firebase config object
            apiKey: "AIzaSyBcxenhaF6c9RMaRwoXeA1tuxxS-a1sA5k",
            authDomain: "pirimhesap-eb53b.firebaseapp.com",
            projectId: "pirimhesap-eb53b",
            storageBucket: "pirimhesap-eb53b.appspot.com",
            messagingSenderId: "842754627809",
            appId: "1:842754627809:web:ba796f62c3a894ef29bfa0"
        };
        
        // --- Firebase Initialization (v11 modular syntax) ---
        let app, db, auth;
        try {
            app = window.firebaseApp(firebaseConfig);
            db = window.firebaseFirestore.getFirestore(app);
            auth = window.firebaseAuth.getAuth(app);
        } catch (e) {
            console.error("Firebase başlatılamadı. Yapılandırmayı kontrol edin.", e);
        }
        const appId = firebaseConfig.projectId;


        // --- Helper Functions & Constants ---
        const formatCurrency = (value, currency = 'TRY') => new Intl.NumberFormat('tr-TR', { style: 'currency', currency }).format(value || 0);
        const formatDate = (dateStr) => {
            if (!dateStr) return "Geçersiz Tarih";
            const date = new Date(dateStr);
            if (isNaN(date)) return "Geçersiz Tarih";
            return date.toLocaleDateString('tr-TR');
        };
        const toInputDate = (date) => {
            if(!date) return '';
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const PAYMENT_METHOD_COLORS = { 'Nakit': '#22c55e', 'Kredi Kartı': '#3b82f6' };

        // --- Icon Component ---
        const Icon = ({ name, size = 16, className = '' }) => {
            useEffect(() => {
                if (window.lucide) {
                    lucide.createIcons();
                }
            });
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };
        
        // --- UI Components ---
        const StatCard = ({ title, value, icon, color }) => (
            <div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm flex items-center space-x-4 transition-transform hover:scale-105">
                <div className={`p-3 rounded-full ${color}`}>{icon}</div>
                <div><p className="text-sm text-gray-500">{title}</p><p className="text-xl sm:text-2xl font-bold text-gray-800">{value}</p></div>
            </div>
        );

        const Modal = ({ children, isOpen, onClose, title }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div className="bg-gray-100 rounded-2xl shadow-xl w-full max-w-lg m-4">
                        <div className="p-4 sm:p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800 transition"><Icon name="x" size={24} /></button>
                        </div>
                        <div className="p-4 sm:p-6 max-h-[75vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        const Input = ({ label, ...props }) => (
            <div><label className="block text-sm font-medium text-gray-700 mb-1">{label}</label><input {...props} className="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" /></div>
        );

        const Select = ({ label, children, ...props }) => (
            <div><label className="block text-sm font-medium text-gray-700 mb-1">{label}</label><select {...props} className="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">{children}</select></div>
        );

        const Button = ({ children, onClick, className = 'bg-blue-600 hover:bg-blue-700 text-white', type = 'button', disabled = false }) => (
            <button type={type} onClick={onClick} disabled={disabled} className={`flex justify-center items-center space-x-2 px-4 py-3 rounded-lg font-semibold transition shadow-sm ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}>{children}</button>
        );
        
        // --- Form Components ---
        const SaleForm = ({ sale, items, personnel, onSave, onCancel, usdToTryRate }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [isSuggestionsVisible, setIsSuggestionsVisible] = useState(false);
            const [formData, setFormData] = useState({
                personnelId: '',
                itemId: '',
                quantity: 1,
                date: new Date().toISOString().split('T')[0],
                paymentMethod: 'credit_card',
                unitPrice: ''
            });
            const [totalPrice, setTotalPrice] = useState('');

            // Initialize form for editing
            useEffect(() => {
                if (sale) {
                    const selectedItem = items.find(i => i.id === sale.itemId);
                    setSearchTerm(selectedItem?.name || '');
                    setFormData({
                        personnelId: sale.personnelId || '',
                        itemId: sale.itemId || '',
                        quantity: sale.quantity || 1,
                        date: toInputDate(sale.date) || new Date().toISOString().split('T')[0],
                        paymentMethod: sale.paymentMethod || 'credit_card',
                        unitPrice: sale.price || '',
                    });
                    setTotalPrice(sale.totalPrice || '');
                } else {
                    // Reset for new sale
                     setFormData({
                        personnelId: '',
                        itemId: '',
                        quantity: 1,
                        date: new Date().toISOString().split('T')[0],
                        paymentMethod: 'credit_card',
                        unitPrice: ''
                    });
                    setTotalPrice('');
                    setSearchTerm('');
                }
            }, [sale, items]);


            // Auto-calculate total price when unit price or quantity changes
            useEffect(() => {
                const unitPrice = parseFloat(formData.unitPrice);
                const quantity = parseInt(formData.quantity, 10);
                if (!isNaN(unitPrice) && !isNaN(quantity)) {
                    setTotalPrice((unitPrice * quantity).toFixed(2));
                }
            }, [formData.unitPrice, formData.quantity]);


            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleTotalPriceChange = (e) => {
                setTotalPrice(e.target.value);
            };

            const handleSearchChange = (e) => {
                const value = e.target.value;
                setSearchTerm(value);
                setFormData(prev => ({ ...prev, itemId: '', unitPrice: '' }));
                setIsSuggestionsVisible(true);
            };

            const handleSuggestionClick = (item) => {
                setFormData(prev => ({
                    ...prev,
                    itemId: item.id,
                    unitPrice: item.price
                }));
                setSearchTerm(item.name);
                setIsSuggestionsVisible(false);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const selectedItem = items.find(i => i.id === formData.itemId);
                const selectedPersonnel = personnel.find(p => p.id === formData.personnelId);
                if (!selectedItem || !selectedPersonnel || !usdToTryRate) {
                    alert("Lütfen personel ve ürün/hizmet seçtiğinizden emin olun.");
                    return;
                }

                const quantity = parseInt(formData.quantity, 10);
                const finalTotalPrice = parseFloat(totalPrice);
                if (isNaN(quantity) || isNaN(finalTotalPrice)) {
                    alert("Lütfen geçerli adet ve tutar girin.");
                    return;
                }
                const finalUnitPrice = finalTotalPrice / quantity;

                let itemCostInTry;
                if (selectedItem.costType === 'percentage') {
                    itemCostInTry = finalUnitPrice * (selectedItem.cost / 100);
                } else {
                    itemCostInTry = selectedItem.cost;
                    if (selectedItem.costCurrency === 'USD') {
                        itemCostInTry = selectedItem.cost * usdToTryRate;
                    }
                }

                let totalCost = itemCostInTry * quantity;
                let kdvTutari = 0;
                if (formData.paymentMethod === 'credit_card') {
                    const creditCardCost = finalTotalPrice * 0.22;
                    totalCost += creditCardCost;
                    kdvTutari = finalTotalPrice * 0.20;
                }
                const netProfit = finalTotalPrice - totalCost;
                const commissionRate = selectedItem.commissionRateCash;
                const personnelCommission = netProfit * (commissionRate / 100);

                onSave({
                    ...formData,
                    price: finalUnitPrice, // Save the recalculated unit price
                    quantity,
                    totalPrice: finalTotalPrice,
                    totalCost,
                    netProfit,
                    kdvTutari,
                    personnelCommission,
                    itemName: selectedItem.name,
                    personnelName: selectedPersonnel.name
                });
            };
            
            const filteredItems = useMemo(() => searchTerm ? items.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase())) : [], [items, searchTerm]);

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <Select label="Personel" name="personnelId" value={formData.personnelId} onChange={handleChange} required>
                        <option value="">Personel Seçin</option>
                        {personnel.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                    </Select>
                    
                    <div className="relative">
                        <Input label="Ürün/Hizmet Ara" type="text" value={searchTerm} onChange={handleSearchChange} onBlur={() => setTimeout(() => setIsSuggestionsVisible(false), 200)} onFocus={handleSearchChange} placeholder="Aramak için yazın..." required/>
                        {isSuggestionsVisible && filteredItems.length > 0 && (
                            <ul className="absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg -mt-1 max-h-60 overflow-y-auto shadow-lg">
                                {filteredItems.map(item => (
                                    <li key={item.id} className="px-4 py-2 cursor-pointer hover:bg-gray-100" onMouseDown={() => handleSuggestionClick(item)}>
                                        {item.name} <span className="text-sm text-gray-500">({formatCurrency(item.price)})</span>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <Input label="Birim Fiyatı (TRY)" name="unitPrice" type="number" step="0.01" min="0" value={formData.unitPrice} onChange={handleChange} required />
                         <Input label="Adet" name="quantity" type="number" min="1" value={formData.quantity} onChange={handleChange} required />
                    </div>

                    <Input label="Toplam Tutar (TRY)" name="totalPrice" type="number" step="0.01" min="0" value={totalPrice} onChange={handleTotalPriceChange} required />

                    <Select label="Ödeme Yöntemi" name="paymentMethod" value={formData.paymentMethod} onChange={handleChange} required>
                        <option value="credit_card">Kredi Kartı</option>
                        <option value="cash">Nakit</option>
                    </Select>
                    
                    <Input label="Tarih" name="date" type="date" value={formData.date} onChange={handleChange} required />
                    
                    <div className="flex justify-end space-x-3 pt-4">
                        <Button onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-gray-800">İptal</Button>
                        <Button type="submit" disabled={!usdToTryRate || !formData.itemId}>{!usdToTryRate ? 'Kur bilgisi bekleniyor...' : 'Kaydet'}</Button>
                    </div>
                </form>
            );
        };
        const PersonnelForm = ({ person, onSave, onCancel }) => { const [name, setName] = useState(person?.name || ''); const handleSubmit = (e) => { e.preventDefault(); onSave({ name }); }; return (<form onSubmit={handleSubmit} className="space-y-4"><Input label="Personel Adı" type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Örn: Ahmet Yılmaz" required /><div className="flex justify-end space-x-3 pt-4"><Button onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-gray-800">İptal</Button><Button type="submit">Kaydet</Button></div></form>); };
        
        const ItemForm = ({ item, onSave, onCancel }) => { 
            const [formData, setFormData] = useState({ 
                name: item?.name || '', 
                price: item?.price || '', 
                cost: item?.cost || '', 
                costCurrency: item?.costCurrency || 'TRY', 
                costType: item?.costType || 'fixed',
                commissionRateCash: item?.commissionRateCash || 0, 
                type: item?.type || 'product' 
            }); 
            
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value })); 
            
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                onSave({ ...formData, price: parseFloat(formData.price), cost: parseFloat(formData.cost), commissionRateCash: parseFloat(formData.commissionRateCash) }); 
            }; 
            
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <Select label="Tip" name="type" value={formData.type} onChange={handleChange} required>
                        <option value="product">Ürün</option>
                        <option value="service">Hizmet</option>
                    </Select>
                    <Input label="Adı" name="name" type="text" value={formData.name} onChange={handleChange} placeholder="Örn: Laptop" required />
                    <Input label="Satış Fiyatı (Birim)" name="price" type="number" step="0.01" min="0" value={formData.price} onChange={handleChange} placeholder="Örn: 15000" required />
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <Select label="Maliyet Türü" name="costType" value={formData.costType} onChange={handleChange} required>
                            <option value="fixed">Sabit Fiyat</option>
                            <option value="percentage">Yüzde (%)</option>
                        </Select>
                        <Input 
                            label={formData.costType === 'percentage' ? "Maliyet Yüzdesi (%)" : "Maliyet (Birim)"}
                            name="cost" 
                            type="number" 
                            step="0.01" 
                            min="0" 
                            value={formData.cost} 
                            onChange={handleChange} 
                            placeholder={formData.costType === 'percentage' ? "Örn: 70" : "Örn: 12000"} 
                            required 
                        />
                    </div>
                    {formData.costType === 'fixed' && (
                        <Select label="Maliyet Para Birimi" name="costCurrency" value={formData.costCurrency} onChange={handleChange} required>
                            <option value="TRY">TRY</option>
                            <option value="USD">USD</option>
                        </Select>
                    )}

                    <Input label="Prim Oranı (%)" name="commissionRateCash" type="number" step="0.1" min="0" max="100" value={formData.commissionRateCash} onChange={handleChange} placeholder="Örn: 12" required />
                    <div className="flex justify-end space-x-3 pt-4">
                        <Button onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-gray-800">İptal</Button>
                        <Button type="submit">Kaydet</Button>
                    </div>
                </form>
            ); 
        };

        const ExcelImportModal = ({ isOpen, onClose, onImport }) => {
            const [file, setFile] = useState(null); const [loading, setLoading] = useState(false); const [error, setError] = useState('');
            const handleDownloadTemplate = () => { if (typeof XLSX === 'undefined') { setError('Excel kütüphanesi henüz yüklenmedi.'); return; } const templateData = [{ name: 'Örnek Ürün', type: 'product', price: 3500, cost: 2000, costCurrency: 'TRY', commissionRateCash: 15 }]; const ws = XLSX.utils.json_to_sheet(templateData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Sablon'); XLSX.writeFile(wb, 'Urun_Hizmet_Sablonu.xlsx'); };
            const handleFileChange = (e) => { setFile(e.target.files[0]); setError(''); };
            const handleImport = () => { if (!file) { setError('Lütfen bir dosya seçin.'); return; } if (typeof XLSX === 'undefined') { setError('Excel kütüphanesi yüklenemedi.'); return; } setLoading(true); setError(''); const reader = new FileReader(); reader.onload = async (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; await onImport(XLSX.utils.sheet_to_json(worksheet)); onClose(); } catch (err) { setError(err.message || 'Dosya işlenemedi.'); } finally { setLoading(false); } }; reader.onerror = () => { setError('Dosya okunurken hata.'); setLoading(false); }; reader.readAsArrayBuffer(file); };
            return (<Modal isOpen={isOpen} onClose={onClose} title="Excel'den Yükle"><div className="space-y-4"><div className="p-4 border border-blue-200 bg-blue-50 rounded-lg text-sm text-blue-800"><p className="font-semibold">Adım 1: Şablonu İndirin</p><p>Sütunlar: name, type, price, cost, costCurrency, commissionRateCash</p></div><Button onClick={handleDownloadTemplate} className="bg-gray-600 hover:bg-gray-700 text-white"><Icon name="download" size={18} /><span>Şablonu İndir</span></Button><hr /><div className="p-4 border border-green-200 bg-green-50 rounded-lg text-sm text-green-800"><p className="font-semibold">Adım 2: Dosyanızı Yükleyin</p><p>Hazırladığınız Excel dosyasını seçip "Yükle" butonuna tıklayın.</p></div><Input type="file" onChange={handleFileChange} accept=".xlsx, .xls" />{error && <p className="text-red-600 text-sm">{error}</p>}<Button onClick={handleImport} disabled={loading || !file}>{loading ? <><div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> Yükleniyor...</> : <><Icon name="upload" size={18}/> Yükle</>}</Button></div></Modal>);
        };
        
        // Chart.js Wrapper Component
        const ChartComponent = ({ type, data, options }) => {
            const chartRef = useRef(null); const chartInstance = useRef(null);
            useEffect(() => { if (chartInstance.current) { chartInstance.current.destroy(); } if (chartRef.current) { const ctx = chartRef.current.getContext('2d'); chartInstance.current = new Chart(ctx, { type, data, options }); } return () => { if (chartInstance.current) { chartInstance.current.destroy(); } }; }, [data, options, type]);
            return <div className="chart-container"><canvas ref={chartRef}></canvas></div>;
        };

        // --- View Components ---
        const Dashboard = ({ allSales, personnel }) => {
            const [filter, setFilter] = useState('this_month');
            const [customDates, setCustomDates] = useState({ start: toInputDate(new Date()), end: toInputDate(new Date()) });
            
            const sales = useMemo(() => {
                if (filter === 'all_time') return allSales;
                let startDate, endDate;
                const now = new Date();
                
                if (filter === 'this_week') {
                    const today = new Date();
                    const dayOfWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - dayOfWeek);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date();
                } else if (filter === 'last_week') {
                    const today = new Date();
                    const dayOfWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() - dayOfWeek - 1);
                    endDate.setHours(23, 59, 59, 999);
                    startDate = new Date(endDate);
                    startDate.setDate(endDate.getDate() - 6);
                    startDate.setHours(0, 0, 0, 0);
                } else if (filter === 'this_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999); // **FIXED**
                } else if (filter === 'last_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    endDate.setHours(23, 59, 59, 999); // **FIXED**
                } else if (filter === 'custom' && customDates.start && customDates.end) {
                    startDate = new Date(customDates.start);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(customDates.end);
                    endDate.setHours(23, 59, 59, 999);
                } else {
                    return allSales;
                }
                
                return allSales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= startDate && saleDate <= endDate;
                });
            }, [allSales, filter, customDates]);
            
            const totalRevenue = useMemo(() => sales.reduce((sum, sale) => sum + sale.totalPrice, 0), [sales]); const totalNetProfit = useMemo(() => sales.reduce((sum, sale) => sum + sale.netProfit, 0), [sales]); const totalCommission = useMemo(() => sales.reduce((sum, sale) => sum + sale.personnelCommission, 0), [sales]); const totalKDV = useMemo(() => sales.reduce((sum, sale) => sum + (sale.kdvTutari || 0), 0), [sales]);
            const commissionByPersonnel = useMemo(() => { const data = personnel.map(p => ({ name: p.name, value: sales.filter(s => s.personnelId === p.id).reduce((sum, s) => sum + s.personnelCommission, 0) })); return data.filter(d => d.value > 0).sort((a, b) => b.value - a.value); }, [sales, personnel]);
            const paymentMethodDistribution = useMemo(() => { const data = sales.reduce((acc, sale) => { const method = sale.paymentMethod === 'cash' ? 'Nakit' : 'Kredi Kartı'; acc[method] = (acc[method] || 0) + sale.totalPrice; return acc; }, {}); return Object.entries(data).map(([name, value]) => ({ name, value })); }, [sales]);
            const lineChartData = useMemo(() => { const data = {}; sales.forEach(sale => { const month = new Date(sale.date).toLocaleString('tr-TR', { month: 'short', year: 'numeric' }); if (!data[month]) { data[month] = { Ciro: 0, "Net Kâr": 0 }; } data[month].Ciro += sale.totalPrice; data[month]["Net Kâr"] += sale.netProfit; }); const sortedMonths = Object.keys(data).sort((a, b) => { const [monthA, yearA] = a.split(' '); const [monthB, yearB] = b.split(' '); const monthMap = { 'Oca': 0, 'Şub': 1, 'Mar': 2, 'Nis': 3, 'May': 4, 'Haz': 5, 'Tem': 6, 'Ağu': 7, 'Eyl': 8, 'Eki': 9, 'Kas': 10, 'Ara': 11 }; return new Date(yearA, monthMap[monthA]) - new Date(yearB, monthMap[monthB]); }); return { labels: sortedMonths, datasets: [ { label: 'Ciro', data: sortedMonths.map(m => data[m].Ciro), borderColor: '#8884d8', backgroundColor: 'rgba(136, 132, 216, 0.2)', fill: true, tension: 0.3 }, { label: 'Net Kâr', data: sortedMonths.map(m => data[m]["Net Kâr"]), borderColor: '#82ca9d', backgroundColor: 'rgba(130, 202, 157, 0.2)', fill: true, tension: 0.3 } ] }; }, [sales]);
            const pieChartData = { labels: paymentMethodDistribution.map(d => d.name), datasets: [{ data: paymentMethodDistribution.map(d => d.value), backgroundColor: paymentMethodDistribution.map(d => PAYMENT_METHOD_COLORS[d.name]) }] };
            const barChartData = { labels: commissionByPersonnel.map(d => d.name), datasets: [{ label: 'Kazanılan Prim', data: commissionByPersonnel.map(d => d.value), backgroundColor: '#ffc658' }] };
            const FilterButton = ({ value, label }) => (<button onClick={() => setFilter(value)} className={`px-3 py-2 rounded-lg transition text-sm font-semibold ${filter === value ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-700 hover:bg-gray-100'}`}>{label}</button>);

            return (<div className="space-y-6">
                <div className="bg-white p-4 rounded-xl shadow-sm flex flex-col sm:flex-row sm:items-center sm:flex-wrap gap-4">
                    <div className="flex items-center gap-2 flex-wrap">
                        <FilterButton value="this_week" label="Bu Hafta" />
                        <FilterButton value="last_week" label="Geçen Hafta" />
                        <FilterButton value="this_month" label="Bu Ay" />
                        <FilterButton value="last_month" label="Geçen Ay" />
                        <FilterButton value="all_time" label="Tümü" />
                        <FilterButton value="custom" label="Özel" />
                    </div>
                    {filter === 'custom' && (<div className="flex flex-col sm:flex-row items-center gap-2 border-t sm:border-t-0 sm:border-l pt-2 sm:pt-0 mt-2 sm:mt-0 sm:pl-4"><Input type="date" value={customDates.start} onChange={e => setCustomDates(d => ({ ...d, start: e.target.value }))} /><Input type="date" value={customDates.end} onChange={e => setCustomDates(d => ({ ...d, end: e.target.value }))} /></div>)}
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><StatCard title="Toplam Ciro" value={formatCurrency(totalRevenue)} icon={<Icon name="dollar-sign" className="text-white"/>} color="bg-blue-500" /><StatCard title="Toplam Net Kâr" value={formatCurrency(totalNetProfit)} icon={<Icon name="trending-up" className="text-white"/>} color="bg-green-500" /><StatCard title="Toplam Prim" value={formatCurrency(totalCommission)} icon={<Icon name="award" className="text-white"/>} color="bg-amber-500" /><StatCard title="Toplam KDV" value={formatCurrency(totalKDV)} icon={<Icon name="percent" className="text-white"/>} color="bg-red-500" /></div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm"><h3 className="text-lg font-semibold text-gray-800 mb-4">Aylık Finansal Trend</h3><ChartComponent type='line' data={lineChartData} options={{ responsive: true, maintainAspectRatio: false }} /></div><div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm"><h3 className="text-lg font-semibold text-gray-800 mb-4">Ödeme Yöntemi Dağılımı</h3><ChartComponent type='pie' data={pieChartData} options={{ responsive: true, maintainAspectRatio: false }} /></div><div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm lg:col-span-2"><h3 className="text-lg font-semibold text-gray-800 mb-4">Personele Göre Prim Dağılımı</h3><ChartComponent type='bar' data={barChartData} options={{ responsive: true, maintainAspectRatio: false }} /></div></div>
            </div>);
        };
        const PersonnelDetailView = ({ personnel, allSales, onBack }) => {
            const [filter, setFilter] = useState('this_month');
            const [customDates, setCustomDates] = useState({ start: toInputDate(new Date()), end: toInputDate(new Date()) });
            
            const filteredSales = useMemo(() => {
                const personSales = allSales.filter(s => s.personnelId === personnel.id);
                if (filter === 'all_time') return personSales;
                let startDate, endDate;
                const now = new Date();
                
                if (filter === 'this_week') {
                    const today = new Date();
                    const dayOfWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - dayOfWeek);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date();
                } else if (filter === 'last_week') {
                    const today = new Date();
                    const dayOfWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() - dayOfWeek - 1);
                    endDate.setHours(23, 59, 59, 999);
                    startDate = new Date(endDate);
                    startDate.setDate(endDate.getDate() - 6);
                    startDate.setHours(0, 0, 0, 0);
                } else if (filter === 'this_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999); // **FIXED**
                } else if (filter === 'last_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    endDate.setHours(23, 59, 59, 999); // **FIXED**
                } else if (filter === 'custom' && customDates.start && customDates.end) {
                    startDate = new Date(customDates.start);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(customDates.end);
                    endDate.setHours(23, 59, 59, 999);
                } else {
                    return personSales;
                }
                
                return personSales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= startDate && saleDate <= endDate;
                });
            }, [personnel, allSales, filter, customDates]);

            const stats = useMemo(() => ({ totalRevenue: filteredSales.reduce((s, a) => s + a.totalPrice, 0), totalNetProfit: filteredSales.reduce((s, a) => s + a.netProfit, 0), totalCommission: filteredSales.reduce((s, a) => s + a.personnelCommission, 0), totalSalesCount: filteredSales.length }), [filteredSales]);
            const FilterButton = ({ value, label }) => (<button onClick={() => setFilter(value)} className={`px-3 py-2 rounded-lg transition text-sm font-semibold ${filter === value ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-700 hover:bg-gray-100'}`}>{label}</button>);
            return (<div className="space-y-6"><div className="flex justify-between items-center"><Button onClick={onBack} className="w-auto bg-gray-200 hover:bg-gray-300 text-gray-800"><Icon name="arrow-left" size={20}/> Geri Dön</Button><h2 className="text-xl md:text-2xl font-bold text-gray-800 text-right">{personnel.name} Performansı</h2></div><div className="bg-white p-4 rounded-xl shadow-sm flex flex-col sm:flex-row sm:items-center sm:flex-wrap gap-4"><div className="flex items-center gap-2 flex-wrap"><FilterButton value="this_week" label="Bu Hafta" /><FilterButton value="last_week" label="Geçen Hafta" /><FilterButton value="this_month" label="Bu Ay" /><FilterButton value="last_month" label="Geçen Ay" /><FilterButton value="all_time" label="Tümü" /><FilterButton value="custom" label="Özel" /></div>{filter === 'custom' && (<div className="flex flex-col sm:flex-row items-center gap-2 border-t sm:border-t-0 sm:border-l mt-2 pt-2 sm:mt-0 sm:pt-0 sm:pl-4"><Input type="date" value={customDates.start} onChange={e => setCustomDates(d => ({ ...d, start: e.target.value }))} /><Input type="date" value={customDates.end} onChange={e => setCustomDates(d => ({ ...d, end: e.target.value }))} /></div>)}</div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><StatCard title="Toplam Satış (Ciro)" value={formatCurrency(stats.totalRevenue)} icon={<Icon name="dollar-sign" className="text-white" />} color="bg-blue-500" /><StatCard title="Toplam Net Kâr" value={formatCurrency(stats.totalNetProfit)} icon={<Icon name="trending-up" className="text-white" />} color="bg-green-500" /><StatCard title="Toplam Prim" value={formatCurrency(stats.totalCommission)} icon={<Icon name="award" className="text-white" />} color="bg-amber-500" /><StatCard title="Toplam İşlem" value={stats.totalSalesCount} icon={<Icon name="briefcase" className="text-white" />} color="bg-indigo-500" /></div><DataTable columns={[{ key: 'date', header: 'Tarih', render: (date) => formatDate(date), sortable: true }, { key: 'itemName', header: 'Ürün/Hizmet', sortable: true }, { key: 'totalPrice', header: 'Tutar', render: (price) => formatCurrency(price), sortable: true }, { key: 'netProfit', header: 'Net Kâr', render: (profit) => formatCurrency(profit), sortable: true }, { key: 'personnelCommission', header: 'Kazanılan Prim', render: (comm) => formatCurrency(comm), sortable: true }]} data={filteredSales} hideActions /></div>);
        }
        const SalesView = ({ allSales, onEdit, onDelete, onAddItem }) => {
            const [filter, setFilter] = useState('this_month');
            const [customDates, setCustomDates] = useState({ start: toInputDate(new Date()), end: toInputDate(new Date()) });

            const filteredSales = useMemo(() => {
                if (filter === 'all_time') return allSales;
                let startDate, endDate;
                const now = new Date();
                
                if (filter === 'this_week') {
                    const today = new Date();
                    const dayOfWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - dayOfWeek);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date();
                } else if (filter === 'last_week') {
                    const today = new Date();
                    const dayOfWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() - dayOfWeek - 1);
                    endDate.setHours(23, 59, 59, 999);
                    startDate = new Date(endDate);
                    startDate.setDate(endDate.getDate() - 6);
                    startDate.setHours(0, 0, 0, 0);
                } else if (filter === 'this_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                } else if (filter === 'last_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    endDate.setHours(23, 59, 59, 999);
                } else if (filter === 'custom' && customDates.start && customDates.end) {
                    startDate = new Date(customDates.start);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(customDates.end);
                    endDate.setHours(23, 59, 59, 999);
                } else {
                    return allSales;
                }
                
                return allSales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= startDate && saleDate <= endDate;
                });
            }, [allSales, filter, customDates]);

            const handleExportSales = () => {
                if (typeof XLSX === 'undefined') {
                    alert('Excel export library is not available.');
                    return;
                }
                
                const dataToExport = filteredSales.map(sale => ({
                    'Tarih': formatDate(sale.date),
                    'Ürün/Hizmet': sale.itemName,
                    'Personel': sale.personnelName,
                    'Ödeme Yöntemi': sale.paymentMethod === 'cash' ? 'Nakit' : 'Kredi Kartı',
                    'Tutar (TRY)': sale.totalPrice,
                    'Maliyet (TRY)': sale.totalCost,
                    'Prim (TRY)': sale.personnelCommission,
                    'KDV (TRY)': sale.kdvTutari || 0
                }));
                
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Satışlar');
                XLSX.writeFile(wb, `Satis_Raporu_${new Date().toLocaleDateString('tr-TR')}.xlsx`);
            };

            const FilterButton = ({ value, label }) => (<button onClick={() => setFilter(value)} className={`px-3 py-2 rounded-lg transition text-sm font-semibold ${filter === value ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-700 hover:bg-gray-100'}`}>{label}</button>);
            const paymentMethodRender = (method) => (method === 'cash' ? <span className="flex items-center"><Icon name="banknote" size={16} className="mr-2 text-green-600"/>Nakit</span> : <span className="flex items-center"><Icon name="credit-card" size={16} className="mr-2 text-blue-600"/>Kredi Kartı</span>);
            const formatCurrencyCell = (value) => formatCurrency(value);

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-xl shadow-sm flex flex-col sm:flex-row sm:items-center sm:flex-wrap gap-4">
                         <div className="flex items-center gap-2 flex-wrap">
                            <FilterButton value="this_week" label="Bu Hafta" />
                            <FilterButton value="last_week" label="Geçen Hafta" />
                            <FilterButton value="this_month" label="Bu Ay" />
                            <FilterButton value="last_month" label="Geçen Ay" />
                            <FilterButton value="all_time" label="Tümü" />
                            <FilterButton value="custom" label="Özel" />
                        </div>
                        {filter === 'custom' && (<div className="flex flex-col sm:flex-row items-center gap-2 border-t sm:border-t-0 sm:border-l pt-2 sm:pt-0 mt-2 sm:mt-0 sm:pl-4"><Input type="date" value={customDates.start} onChange={e => setCustomDates(d => ({ ...d, start: e.target.value }))} /><Input type="date" value={customDates.end} onChange={e => setCustomDates(d => ({ ...d, end: e.target.value }))} /></div>)}
                    </div>
                    <DataTable 
                        columns={[
                            { key: 'date', header: 'Tarih', render: formatDate, sortable: true }, 
                            { key: 'itemName', header: 'Ürün/Hizmet', sortable: true }, 
                            { key: 'personnelName', header: 'Personel', sortable: true }, 
                            { key: 'paymentMethod', header: 'Ödeme', render: paymentMethodRender, sortable: true }, 
                            { key: 'totalPrice', header: 'Tutar', render: formatCurrencyCell, sortable: true }, 
                            { key: 'totalCost', header: 'Maliyet', render: formatCurrencyCell, sortable: true }, 
                            { key: 'personnelCommission', header: 'Prim', render: formatCurrencyCell, sortable: true }, 
                            { key: 'kdvTutari', header: 'KDV', render: (kdv) => kdv ? formatCurrencyCell(kdv) : '-', sortable: true }
                        ]} 
                        data={filteredSales} 
                        onEdit={onEdit} 
                        onDelete={onDelete} 
                        onAddItem={onAddItem}
                        addItemLabel="Yeni Satış Ekle"
                        onExport={handleExportSales}
                    />
                </div>
            );
        };
        const DataTable = ({ columns, data, onEdit, onDelete, onViewDetails, onAddItem, addItemLabel, onImport, onExport, hideActions = false }) => {
            const [sortConfig, setSortConfig] = useState(null);
            const sortedData = useMemo(() => { let sortableItems = [...data]; if (sortConfig !== null) { sortableItems.sort((a, b) => { const valA = a[sortConfig.key] || ''; const valB = b[sortConfig.key] || ''; if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1; if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1; return 0; }); } return sortableItems; }, [data, sortConfig]);
            const requestSort = (key) => { let direction = 'ascending'; if (sortConfig && sortConfig.key === key && sortConfig.direction === 'ascending') { direction = 'descending'; } setSortConfig({ key, direction }); };
            return (<div className="bg-white p-4 sm:p-6 rounded-2xl shadow-sm"><div className="flex flex-col sm:flex-row justify-end mb-4 space-y-2 sm:space-y-0 sm:space-x-3">{onImport && (<Button onClick={onImport} className="bg-green-600 hover:bg-green-700 text-white"><Icon name="upload" size={18}/><span>Excel'den Yükle</span></Button>)}{onExport && (<Button onClick={onExport} className="bg-teal-600 hover:bg-teal-700 text-white"><Icon name="download" size={18}/><span>Excel'e Aktar</span></Button>)}{onAddItem && (<Button onClick={onAddItem} className="w-full sm:w-auto"><Icon name="plus" size={18}/><span>{addItemLabel}</span></Button>)}</div><div className="overflow-x-auto"><table className="w-full text-left"><thead><tr className="border-b border-gray-200">{columns.map(col => (<th key={col.key} className="p-2 md:p-4 text-sm font-semibold text-gray-600 cursor-pointer whitespace-nowrap" onClick={() => col.sortable && requestSort(col.key)}><div className="flex items-center">{col.header}{col.sortable && sortConfig?.key === col.key && (sortConfig.direction === 'ascending' ? <Icon name="chevron-up" size={16} /> : <Icon name="chevron-down" size={16} />)}</div></th>))}{!hideActions && <th className="p-2 md:p-4 text-sm font-semibold text-gray-600 text-right">İşlemler</th>}</tr></thead><tbody>{sortedData.map(item => (<tr key={item.id} className="border-b border-gray-100 hover:bg-gray-50">{columns.map(col => (<td key={col.key} className="p-2 md:p-4 text-gray-700 whitespace-nowrap">{col.render ? col.render(item[col.key], item) : item[col.key]}</td>))}{!hideActions && <td className="p-2 md:p-4"><div className="flex space-x-3 justify-end">{onViewDetails && <button onClick={() => onViewDetails(item.id)} className="text-green-600 hover:text-green-800" title="Detayları Gör"><Icon name="eye" size={18} /></button>}{onEdit && <button onClick={() => onEdit(item)} className="text-blue-600 hover:text-blue-800" title="Düzenle"><Icon name="edit" size={18} /></button>}{onDelete && <button onClick={() => onDelete(item.id)} className="text-red-600 hover:text-red-800" title="Sil"><Icon name="trash-2" size={18} /></button>}</div></td>}</tr>))}</tbody></table></div>{sortedData.length === 0 && <p className="text-center text-gray-500 py-8">Gösterilecek veri bulunamadı.</p>}</div>);
        };

        // --- App Component (Main Logic) ---
        const App = () => {
            const [userId, setUserId] = useState(null); const [isAuthReady, setIsAuthReady] = useState(false); const [view, setView] = useState('dashboard'); const [sales, setSales] = useState([]); const [items, setItems] = useState([]); const [personnel, setPersonnel] = useState([]); const [isSaleModalOpen, setSaleModalOpen] = useState(false); const [isItemModalOpen, setItemModalOpen] = useState(false); const [isPersonnelModalOpen, setPersonnelModalOpen] = useState(false); const [isImportModalOpen, setImportModalOpen] = useState(false); const [editingSale, setEditingSale] = useState(null); const [editingItem, setEditingItem] = useState(null); const [editingPersonnel, setEditingPersonnel] = useState(null); const [selectedPersonnelId, setSelectedPersonnelId] = useState(null); const [usdToTryRate, setUsdToTryRate] = useState(null);
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [itemSearchTerm, setItemSearchTerm] = useState('');
            const [isDeleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
            const [itemToDelete, setItemToDelete] = useState({ collectionName: '', id: '' });


            const filteredItems = useMemo(() =>
                items.filter(item =>
                    item.name.toLowerCase().includes(itemSearchTerm.toLowerCase())
                ), [items, itemSearchTerm]);

            useEffect(() => { if (window.lucide) { lucide.createIcons(); } }, [view, isSaleModalOpen, isItemModalOpen, isPersonnelModalOpen, isImportModalOpen, isSidebarOpen, items, sales, personnel, isDeleteConfirmOpen]);
            useEffect(() => { fetch('https://api.exchangerate-api.com/v4/latest/USD').then(response => response.json()).then(data => setUsdToTryRate(data.rates.TRY)).catch(error => { console.error(error); setUsdToTryRate(32.0); }); }, []);
            useEffect(() => { if(!auth) return; const unsubscribe = window.firebaseAuth.onAuthStateChanged(auth, (user) => { if (user) { setUserId(user.uid); } else { window.firebaseAuth.signInAnonymously(auth).catch(err => console.error(err)); } setIsAuthReady(true); }); return () => unsubscribe(); }, []);
            useEffect(() => { 
                if (!isAuthReady || !userId || !db) return; 
                const { collection, onSnapshot } = window.firebaseFirestore; 
                
                const unsubSales = onSnapshot(collection(db, 'sales'), (snapshot) => {
                    const salesData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    salesData.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setSales(salesData);
                });

                const unsubItems = onSnapshot(collection(db, 'items'), (s) => setItems(s.docs.map(d => ({ id: d.id, ...d.data() })))); 
                const unsubPersonnel = onSnapshot(collection(db, 'personnel'), (s) => setPersonnel(s.docs.map(d => ({ id: d.id, ...d.data() })))); 
                return () => { unsubSales(); unsubItems(); unsubPersonnel(); }; 
            }, [isAuthReady, userId]);
            
            const handleSave = async (collectionName, data, id) => { try { const { collection, doc, updateDoc, addDoc } = window.firebaseFirestore; if (id) await updateDoc(doc(db, collectionName, id), data); else await addDoc(collection(db, collectionName), data); } catch (e) { console.error(e); } setSaleModalOpen(false); setItemModalOpen(false); setPersonnelModalOpen(false); setEditingSale(null); setEditingItem(null); setEditingPersonnel(null); };
            
            const handleBulkImport = async (importedData) => {
                const { writeBatch, collection, doc } = window.firebaseFirestore;
                const batch = writeBatch(db);
                if (!importedData || importedData.length === 0) throw new Error("Dosya boş.");

                const existingItems = items; // Use current items from state

                importedData.forEach(importedItem => {
                    const name = String(importedItem.name || '').trim();
                    const price = parseFloat(importedItem.price);

                    if (!name || isNaN(price)) {
                        console.warn("Geçersiz ürün atlanıyor:", importedItem);
                        return; // Skips to the next item in the loop
                    }

                    // Check if an item with the same name and price already exists
                    const isDuplicate = existingItems.some(existingItem => 
                        existingItem.name.toLowerCase() === name.toLowerCase() && 
                        existingItem.price === price
                    );
                    
                    if (!isDuplicate) {
                        const cost = parseFloat(importedItem.cost);
                        const cashRate = parseFloat(importedItem.commissionRateCash);
                        const newItem = {
                            name: name,
                            type: String(importedItem.type || 'product').toLowerCase(),
                            price: price,
                            cost: isNaN(cost) ? 0 : cost,
                            costCurrency: ['TRY', 'USD'].includes(String(importedItem.costCurrency || '').toUpperCase()) ? String(importedItem.costCurrency).toUpperCase() : 'TRY',
                            commissionRateCash: isNaN(cashRate) ? 0 : cashRate,
                        };
                        const newDocRef = doc(collection(db, 'items'));
                        batch.set(newDocRef, newItem);
                    }
                });

                try {
                    await batch.commit();
                } catch (e) {
                    console.error("Toplu içe aktarma sırasında hata:", e);
                    throw new Error("Yazma izni reddedildi veya başka bir hata oluştu. Firebase kurallarını kontrol edin.");
                }
            };
            
            const handleDeleteConfirmation = (collectionName, id) => {
                setItemToDelete({ collectionName, id });
                setDeleteConfirmOpen(true);
            };

            const handleDelete = async () => {
                if (!itemToDelete.id || !itemToDelete.collectionName) return;
                try {
                    await window.firebaseFirestore.deleteDoc(window.firebaseFirestore.doc(db, itemToDelete.collectionName, itemToDelete.id));
                } catch (e) {
                    console.error("Silme işlemi sırasında hata:", e);
                }
                setDeleteConfirmOpen(false);
                setItemToDelete({ collectionName: '', id: '' });
            };


            const openModal = (type, item = null) => { switch (type) { case 'sale': setEditingSale(item); setSaleModalOpen(true); break; case 'item': setEditingItem(item); setItemModalOpen(true); break; case 'personnel': setEditingPersonnel(item); setPersonnelModalOpen(true); break; case 'import': setImportModalOpen(true); break; } };
            const handleViewChange = (newView) => {
                setView(newView);
                setSelectedPersonnelId(null);
                setSidebarOpen(false);
            };

            const renderView = () => {
                const costRender = (cost, item) => {
                    if (item.costType === 'percentage') {
                        return `${cost}%`;
                    }
                    return item.costCurrency === 'USD' ? `${formatCurrency(cost, 'USD')}` : `${formatCurrency(cost, 'TRY')}`;
                };

                const formatCurrencyCell = (value) => formatCurrency(value);
                switch (view) {
                    case 'dashboard': return <Dashboard allSales={sales} personnel={personnel} />;
                    case 'sales': return <SalesView allSales={sales} onEdit={(item) => openModal('sale', item)} onDelete={(id) => handleDeleteConfirmation('sales', id)} onAddItem={() => openModal('sale')} />;
                    case 'personnel': if (selectedPersonnelId) { const person = personnel.find(p => p.id === selectedPersonnelId); return <PersonnelDetailView personnel={person} allSales={sales} onBack={() => setSelectedPersonnelId(null)} />; } return <DataTable columns={[{ key: 'name', header: 'Personel Adı', sortable: true }]} data={personnel} onViewDetails={(id) => setSelectedPersonnelId(id)} onEdit={(item) => openModal('personnel', item)} onDelete={(id) => handleDeleteConfirmation('personnel', id)} onAddItem={() => openModal('personnel')} addItemLabel="Yeni Personel Ekle" />;
                    case 'items': 
                        return (
                            <div className="space-y-6">
                                <Input
                                    label="Ürün/Hizmet Ara"
                                    type="text"
                                    placeholder="Aramak için yazın..."
                                    value={itemSearchTerm}
                                    onChange={(e) => setItemSearchTerm(e.target.value)}
                                />
                                <DataTable 
                                    columns={[{ key: 'name', header: 'Adı', sortable: true }, { key: 'type', header: 'Tip', render: (t) => t === 'service' ? 'Hizmet' : 'Ürün', sortable: true }, { key: 'price', header: 'Satış Fiyatı', render: formatCurrencyCell, sortable: true }, { key: 'cost', header: 'Maliyet', render: costRender, sortable: true}, { key: 'commissionRateCash', header: 'Prim Oranı (%)', render: (r) => `${r}%`, sortable: true }]} 
                                    data={filteredItems} 
                                    onEdit={(item) => openModal('item', item)} 
                                    onDelete={(id) => handleDeleteConfirmation('items', id)} 
                                    onAddItem={() => openModal('item')} 
                                    addItemLabel="Yeni Ürün/Hizmet" 
                                    onImport={() => openModal('import')} 
                                />
                            </div>
                        );
                    default: return <Dashboard allSales={sales} personnel={personnel} />;
                }
            };
            const NavItem = ({ children, onClick, isActive }) => (<button onClick={onClick} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left transition ${isActive ? 'bg-blue-600 text-white font-semibold shadow' : 'text-gray-600 hover:bg-gray-200'}`}>{children}</button>);
            
            if (!isAuthReady) { return <div className="flex h-screen items-center justify-center bg-gray-100"><div className="text-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div><p className="text-lg mt-4">Uygulama Yükleniyor...</p></div></div>; }
            
            return (
                <div className="relative min-h-screen md:flex bg-gray-100 font-sans">
                    {/* Overlay for mobile */}
                    {isSidebarOpen && <div className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden" onClick={() => setSidebarOpen(false)}></div>}
                    
                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 bg-white p-6 w-64 flex-shrink-0 flex flex-col justify-between shadow-lg z-30 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-transform duration-300 ease-in-out`}>
                        <div>
                                <div className="relative flex justify-center mb-6">
                                    <div className="flex flex-col items-center">
                                        {/* Logo SVG */}
                                        <svg xmlns="http://www.w3.org/2000/svg" xmlSpace="preserve" width="162" height="162" version="1.1" 
                                            style={{shapeRendering:'geometricPrecision', textRendering:'geometricPrecision', imageRendering:'optimizeQuality', fillRule:'evenodd', clipRule:'evenodd'}}
                                            viewBox="0 0 29700 17000"
                                            className="text-blue-600"
                                            xmlnsXlink="http://www.w3.org/1999/xlink">
                                            <g><path fill="currentColor" d="M23827.3 5179.11l5237.61 0 100.72 1957.44 -181.3 0c-282.02,-665.64 -577.51,-1122.05 -886.39,-1369.2 -308.87,-247.16 -762.15,-370.73 -1359.76,-370.73l-352.53 -0.02 0 3054.81 342.48 0c315.61,0 580.82,-116.98 795.69,-350.95 214.92,-233.99 365.96,-548.68 453.25,-944.12l151.08 -0.01 0 2926.26 -171.18 0c-120.9,-494.3 -283.76,-846.88 -488.55,-1057.78 -204.76,-210.93 -485.16,-316.36 -841.04,-316.36l-241.73 0 0 3173.43 382.8 0c617.76,0 1143.15,-181.25 1576.25,-543.74 433.16,-362.5 730.24,-827.13 891.4,-1393.93l201.48 -0.01 -80.58 2155.14 -5529.7 0 0 -217.46 594.29 0 0 -6485.28 -594.29 0 0 -217.49z"/><polygon fill="currentColor" points="22707.92,5366.94 22707.92,12099.34 21297.78,12099.34 17842.98,5703.08 17842.98,11911.52 18396.96,11911.52 18396.96,12099.34 17017.06,12099.34 17017.06,11911.52 17571.03,11911.52 17571.03,5366.94 17017.06,5366.94 17017.06,5179.11 19797.03,5179.11 22435.97,10141.9 22435.97,5366.94 21882,5366.94 21882,5179.11 23261.89,5179.11 23261.89,5366.94 "/><path fill="currentColor" d="M13353.34 12198.23c-1121.37,0 -1959.06,-298.23 -2513.04,-894.69 -553.95,-596.46 -830.96,-1459.84 -830.96,-2590.15 0.01,-1130.3 297.13,-2020.05 891.39,-2669.23 594.27,-649.2 1435.29,-973.78 2523.11,-973.78 1087.82,-0.01 1908.7,308.12 2462.67,924.34 553.99,616.22 830.97,1491.16 830.97,2624.76 0,1133.58 -280.35,2013.45 -841.04,2639.58 -560.68,626.09 -1401.73,939.17 -2523.1,939.17zm1289.27 -3153.66l0 -731.56c0,-1206.1 -60.45,-1967.32 -181.33,-2283.67 -134.28,-362.51 -325.66,-586.58 -574.12,-672.26 -140.99,-52.75 -312.24,-79.09 -513.69,-79.09 -201.43,0 -374.34,26.35 -518.71,79.09 -144.37,52.7 -263.57,144.99 -357.57,276.81 -94.01,131.8 -169.55,270.22 -226.62,415.22 -57.07,144.99 -102.41,349.3 -135.98,612.93 -40.26,382.26 -60.43,945.76 -60.43,1690.52l0.01 711.76c0,804.08 31.88,1375.84 95.67,1715.25 63.8,339.42 142.69,581.64 236.71,726.64 208.16,322.93 530.47,484.41 966.92,484.41 530.5,-0.01 874.62,-219.15 1032.41,-657.43 157.81,-438.28 236.7,-1201.15 236.73,-2288.62z"/><path fill="currentColor" d="M7342.79 5268.08c-1040.81,0 -1561.22,985.34 -1561.22,2955.95l0 780.98c0,935.88 137.65,1669.12 412.96,2199.67 275.32,530.52 681.56,795.83 1218.75,795.83 738.64,-0.02 1416.83,-705.2 2034.59,-2115.62l181.32 0 -70.52 2204.57 -110.78 0c-40.29,-72.49 -77.23,-123.56 -110.81,-153.21 -33.56,-29.67 -82.25,-44.49 -146.04,-44.49 -63.79,0 -307.21,51.07 -730.25,153.23 -423.02,102.15 -852.78,153.24 -1289.24,153.24 -1094.53,0 -1942.28,-289.99 -2543.26,-869.97 -600.98,-580 -901.47,-1451.6 -901.47,-2614.87 0.02,-1163.27 313.92,-2061.23 941.76,-2693.94 627.84,-632.73 1472.24,-949.07 2533.18,-949.07 409.62,-0.01 810.81,51.08 1203.63,153.24 392.85,102.13 622.8,153.23 689.95,153.23 67.17,-0.01 117.52,-14.83 151.08,-44.48 33.6,-29.68 70.51,-80.74 110.8,-153.24l110.8 -0.02 80.59 2145.27 -181.3 0c-302.18,-665.65 -612.73,-1174.77 -931.7,-1527.37 -318.95,-352.62 -683.23,-528.91 -1092.82,-528.93z"/><polygon fill="currentColor" points="355.22,5179.11 3427.25,5179.11 3427.25,5366.94 2873.28,5366.94 2873.28,11911.52 3427.25,11911.52 3427.25,12099.34 355.22,12099.34 355.22,11911.52 909.2,11911.52 909.2,5366.94 355.22,5366.94 "/><path fill="currentColor" d="M16773.62 347.97l2197.13 0 42.25 986.39 -76.06 0c-118.3,-335.43 -242.25,-565.42 -371.82,-689.96 -129.57,-124.55 -319.71,-186.82 -570.41,-186.82l-147.87 -0.01 0 1539.37 143.65 0c132.4,0 243.65,-58.95 333.79,-176.85 90.14,-117.92 153.52,-276.49 190.14,-475.76l63.38 0 0 1474.58 -71.83 0c-50.7,-249.09 -119.02,-426.75 -204.93,-533.03 -85.9,-106.29 -203.51,-159.42 -352.8,-159.42l-101.4 0 0 1599.14 160.55 0c259.15,0 479.56,-91.34 661.25,-274 181.68,-182.67 306.33,-416.81 373.93,-702.42l84.51 -0.01 -33.8 1086.01 -2319.66 0 0 -109.58 249.29 0 0 -3268.03 -249.29 0 0 -109.6z"/><polygon fill="currentColor" points="13553.1,347.97 14871.36,347.97 14871.36,442.62 14626.31,442.62 14626.31,1986.98 15467.12,1986.98 15467.12,442.62 15217.84,442.62 15217.84,347.97 16540.33,347.97 16540.33,442.62 16291.05,442.62 16291.05,3740.53 16540.33,3740.53 16540.33,3835.18 15217.84,3835.18 15217.84,3740.53 15467.12,3740.53 15467.12,2116.49 14626.31,2116.49 14626.31,3740.53 14871.36,3740.53 14871.36,3835.18 13553.1,3835.18 13553.1,3740.53 13802.38,3740.53 13802.38,442.62 13553.1,442.62 "/><path fill="currentColor" d="M13200.86 347.97l42.25 1250.42 -80.28 0c-123.94,-441.71 -233.8,-743.1 -329.57,-904.18 -95.77,-161.08 -233.8,-241.61 -414.07,-241.61l-50.7 -0.01 0 3277.98 359.14 0 0 104.61 -1542.2 0 0 -104.61 359.14 0 0 -3277.98 -54.93 0c-180.28,0 -319.71,83.87 -418.3,251.59 -98.59,167.71 -207.04,465.79 -325.34,894.22l-80.28 -0.01 42.25 -1250.42 2492.89 0z"/><path fill="currentColor" fill-rule="nonzero" d="M734.44 14608.22l598.1 0 0 753.25c26.89,-63.12 67.42,-113.88 121.61,-152.3 54.59,-38.76 137.32,-57.97 247.76,-57.97 256.86,0 385.09,114.57 385.09,343.7l0 619.82 139.39 0 0 37.04 -703.17 0 0 -37.04 101.76 0 0 -668.87c0,-82.33 -6.62,-135.49 -19.86,-159.16 -12.82,-24.35 -36.81,-36.36 -71.56,-36.36 -52.94,0 -99.68,28.81 -140.63,86.44 -40.12,57.62 -60.39,127.6 -60.39,209.92l0 568.03 106.72 0 0 37.04 -704.82 0 0 -37.04 136.49 0 0 -1469.46 -136.49 0 0 -37.04zm2124.39 1059.56l71.97 0 0 -158.13c0,-130.35 -8.69,-217.82 -26.06,-262.41 -17.37,-44.59 -50.88,-66.88 -100.51,-66.88 -29.79,0 -56.67,6.51 -81.08,19.89 -23.99,13.04 -35.98,30.87 -35.98,53.51 0,22.29 4.96,45.28 15.3,68.6l61.63 0c13.65,28.81 20.27,63.46 20.27,103.93 0,40.48 -20.68,75.47 -62.46,104.97 -40.95,29.5 -93.06,44.25 -155.93,44.25 -142.7,0 -213.85,-56.95 -213.85,-170.83 0,-169.1 172.9,-253.48 518.69,-253.48 197.3,0 333.38,27.78 408.66,83.7 75.7,55.56 113.34,157.44 113.34,305.27l0 418.13c0,71.35 23.57,107.02 71.14,107.02 56.67,0 89.76,-70.66 99.69,-211.98l37.22 2.06c-6.62,121.09 -33.91,204.09 -82.31,249.03 -47.57,45.28 -126.16,67.91 -235.77,67.91 -198.12,0 -312.29,-50.76 -342.07,-152.29 -21.51,52.48 -53.77,90.9 -97.2,115.59 -42.6,24.36 -105.48,36.7 -188.2,36.7 -244.87,0 -367.3,-83 -367.3,-249.36 0,-97.08 46.74,-163.62 139.81,-200.32 93.89,-36.71 237.42,-54.88 431,-54.88zm-99.28 253.48c0,71.35 4.55,117.31 13.24,137.89 9.51,20.58 26.89,30.87 52.12,30.87 26.06,0 50.05,-17.49 71.97,-52.48 22.75,-34.99 33.92,-83.35 33.92,-145.09l0 -191.4 -17.38 0c-102.58,0 -153.87,62.42 -153.87,187.28l0 32.93zm1230.96 -891.14c-87.69,0 -150.15,-18.53 -187.37,-55.23 -37.23,-37.04 -55.84,-83.01 -55.84,-137.89 0,-55.22 20.27,-100.5 60.8,-135.83 40.12,-36.02 101.75,-53.85 184.89,-53.85 82.73,0 145.6,16.12 188.2,48.36 43.43,32.25 64.94,78.21 64.94,138.24 0,59.34 -20.68,107.01 -62.45,143.03 -40.96,35.33 -105.48,53.17 -193.17,53.17zm-374.33 142l607.62 0 0 942.6 138.56 0 0 37.04 -736.67 0 0 -37.04 136.5 0 0 -905.55 -146.01 0 0 -37.05zm1625.14 57.63c-61.63,0 -115.4,32.93 -161.73,99.13 -45.91,65.51 -69.08,143.72 -69.08,234.62l0 551.22 176.21 0 0 37.04 -774.31 0 0 -37.04 136.5 0 0 -905.55 -136.5 0 0 -37.05 598.1 0 0 197.92c21.1,-69.97 62.46,-123.82 123.68,-161.9 61.22,-38.07 130.7,-56.94 208.47,-56.94 77.76,0 141.04,18.18 190.26,54.88 48.81,36.02 73.22,87.47 73.22,154.36 0,66.54 -18.2,117.65 -54.6,153.66 -36.4,35.34 -92.24,53.17 -167.93,53.17 -74.87,0 -130.3,-20.58 -165.87,-61.74 -35.57,-41.16 -40.12,-98.1 -13.23,-170.82l88.92 0c40.95,-69.97 23.58,-104.96 -52.11,-104.96zm1498.99 942.59c-213.43,0 -373.51,-45.62 -480.64,-136.51 -106.72,-91.59 -160.07,-218.5 -160.07,-381.09 0,-162.93 59.97,-287.44 179.93,-373.88 119.95,-86.44 272.58,-129.66 458.3,-129.66 375.57,0 555.91,156.41 541.02,469.58l-699.86 0 0 80.27c0,134.12 20.68,235.64 61.63,304.59 41.78,68.6 113.75,102.9 216.33,102.9 191.92,0 317.67,-85.06 377.23,-255.2l44.67 5.83c-31.44,99.13 -88.1,175.97 -170.42,230.85 -81.48,54.88 -204.33,82.32 -368.12,82.32zm-158.84 -592.72l255.62 0 0 -100.5c0,-111.48 -7.85,-187.29 -23.57,-227.76 -15.72,-40.48 -47.15,-60.71 -94.72,-60.71 -46.74,0 -81.49,21.61 -104.24,64.83 -21.92,43.21 -33.09,117.65 -33.09,223.64l0 100.5zm1585.85 -34.99l293.26 -335.46 -178.68 0 0 -37.05 369.36 0 0 37.05 -129.05 0 -323.04 378.68 404.94 526.87 129.05 0 0 37.04 -828.9 0 0 -37.04 176.2 0 -272.99 -370.45 -283.34 370.45 164.21 0 0 37.04 -389.22 0 0 -37.04 163.38 0 315.18 -411.62 -376.81 -493.93 -144.36 0 0 -37.05 838.43 0 0 37.05 -173.31 0 245.69 335.46zm714.75 312.83l0 -648.29 -136.91 0 0 -37.05 136.91 0 0 -265.49 462.02 -94.32 0 359.81 322.21 0 0 37.05 -322.21 0 0 693.22c0,64.83 7.45,112.17 22.75,142.35 15.72,30.19 48.39,45.28 98.44,45.28 49.64,0 93.07,-20.58 129.88,-61.74 37.64,-41.5 62.46,-97.76 73.63,-169.11l42.19 4.81c-13.24,94.32 -49.64,169.44 -109.61,225.01 -59.15,55.57 -157.6,83.35 -294.92,83.35 -137.32,0 -242.38,-22.63 -315.19,-67.91 -72.79,-44.94 -109.19,-127.26 -109.19,-246.97zm1506.43 314.88c-213.43,0 -373.5,-45.62 -480.63,-136.51 -106.72,-91.59 -160.08,-218.5 -160.08,-381.09 0,-162.93 59.98,-287.44 179.93,-373.88 119.95,-86.44 272.58,-129.66 458.3,-129.66 375.57,0 555.91,156.41 541.02,469.58l-699.85 0 0 80.27c0,134.12 20.68,235.64 61.63,304.59 41.77,68.6 113.74,102.9 216.32,102.9 191.93,0 317.67,-85.06 377.23,-255.2l44.67 5.83c-31.43,99.13 -88.1,175.97 -170.41,230.85 -81.48,54.88 -204.33,82.32 -368.13,82.32zm-158.83 -592.72l255.62 0 0 -100.5c0,-111.48 -7.86,-187.29 -23.58,-227.76 -15.71,-40.48 -47.15,-60.71 -94.72,-60.71 -46.74,0 -81.48,21.61 -104.23,64.83 -21.92,43.21 -33.09,117.65 -33.09,223.64l0 100.5zm791.68 -407.5l598.1 0 0 189.35c26.48,-63.12 67.01,-113.88 121.61,-152.3 54.6,-38.76 137.32,-57.97 248.59,-57.97 256.03,0 383.85,114.57 383.85,343.7l0 619.82 139.39 0 0 37.04 -702.34 0 0 -37.04 102.17 0 0 -668.87c0,-82.33 -6.61,-135.49 -20.26,-159.16 -13.24,-24.35 -37.23,-36.36 -71.98,-36.36 -52.94,0 -99.68,28.81 -140.63,86.44 -40.12,57.62 -60.39,127.6 -60.39,209.92l0 568.03 106.3 0 0 37.04 -704.4 0 0 -37.04 136.08 0 0 -905.55 -136.08 0 0 -37.05zm1580.88 1000.22l0 -368.39 29.78 0c43.02,119.37 100.92,203.06 173.73,251.43 72.79,47.67 163.79,71.69 273.4,71.69 168.35,0 252.32,-44.6 252.32,-133.44 0,-38.75 -20.68,-67.57 -61.64,-86.43 -64.52,-30.53 -147.25,-54.2 -248.59,-70.32 -112.09,-24.35 -206.39,-57.28 -282.92,-98.79 -90.58,-49.39 -136.08,-127.6 -136.08,-234.62 0,-107.02 39.71,-192.43 118.71,-256.23 79.42,-64.14 185.31,-96.04 318.08,-96.04 81.07,0 164.62,16.12 250.66,48.02 31.85,10.63 55.84,16.12 72.38,16.12 16.55,0 30.61,-4.8 41.78,-14.06 11.58,-9.95 25.64,-27.79 42.19,-53.85l27.3 0 0 314.88 -29.78 0c-84.38,-178.71 -215.09,-267.89 -391.71,-267.89 -78.17,0 -136.08,11.32 -174.13,34.3 -37.64,22.98 -56.67,51.45 -56.67,85.41 0,20.24 5.79,36.36 16.96,48.36 11.58,11.67 20.68,20.24 26.88,26.07 7.04,5.15 17.79,10.98 32.27,17.5 14.89,6.17 27.3,10.97 37.64,14.06 10.34,3.43 25.64,7.89 45.91,13.72 20.68,5.15 35.98,8.58 46.33,9.95 112.09,23.67 193.16,43.9 242.79,60.71 49.64,17.15 96.79,38.08 141.05,62.77 91.41,51.8 136.91,136.18 136.91,252.46 0,115.93 -41.36,203.75 -124.09,263.09 -82.72,59.68 -196.06,89.52 -340,89.52 -102.58,0 -201.85,-19.89 -297.81,-59.68 -19.85,-11.32 -35.57,-16.81 -47.57,-16.81 -35.98,0 -71.55,25.39 -106.3,76.49l-29.78 0zm4680.61 -574.2c0,-141.32 -8.27,-236.33 -24.82,-285.04 -16.54,-49.05 -48.81,-73.4 -96.79,-73.4 -47.57,0 -90.58,24.69 -129.05,74.43 -38.05,49.05 -57.08,116.97 -57.08,203.41l0 383.14c0,58.66 14.48,108.73 43.02,150.24 28.95,41.16 70.31,61.74 124.08,61.74 54.19,0 91,-30.19 110.86,-90.56 19.85,-60.37 29.78,-166.01 29.78,-316.94l0 -107.02zm-307.74 -989.92l0 720.66c62.87,-118.34 170.41,-177.68 323.04,-177.68 309.39,0 464.09,170.82 464.09,512.8 0,173.91 -42.6,302.19 -127.81,384.86 -85.21,82.32 -213.02,123.48 -383.84,123.48 -86.04,0 -151.81,-10.97 -197.3,-32.58 -45.92,-22.3 -76.53,-58.66 -92.66,-109.42l-17.78 121.42 -565.85 0 0 -37.04 136.5 0 0 -1469.46 -136.5 0 0 -37.04 598.11 0zm1513.88 1564.12c-213.44,0 -373.51,-45.62 -480.64,-136.51 -106.72,-91.59 -160.08,-218.5 -160.08,-381.09 0,-162.93 59.98,-287.44 179.93,-373.88 119.96,-86.44 272.58,-129.66 458.3,-129.66 375.58,0 555.92,156.41 541.03,469.58l-699.86 0 0 80.27c0,134.12 20.68,235.64 61.63,304.59 41.78,68.6 113.75,102.9 216.33,102.9 191.92,0 317.66,-85.06 377.23,-255.2l44.67 5.83c-31.44,99.13 -88.1,175.97 -170.42,230.85 -81.48,54.88 -204.33,82.32 -368.12,82.32zm-158.84 -592.72l255.62 0 0 -100.5c0,-111.48 -7.86,-187.29 -23.57,-227.76 -15.72,-40.48 -47.16,-60.71 -94.72,-60.71 -46.74,0 -81.49,21.61 -104.24,64.83 -21.92,43.21 -33.09,117.65 -33.09,223.64l0 100.5zm1382.34 88.16l71.97 0 0 -158.13c0,-130.35 -8.68,-217.82 -26.06,-262.41 -17.37,-44.59 -50.87,-66.88 -100.5,-66.88 -29.79,0 -56.67,6.51 -81.08,19.89 -23.99,13.04 -35.98,30.87 -35.98,53.51 0,22.29 4.96,45.28 15.3,68.6l61.63 0c13.65,28.81 20.27,63.46 20.27,103.93 0,40.48 -20.68,75.47 -62.46,104.97 -40.95,29.5 -93.06,44.25 -155.93,44.25 -142.71,0 -213.85,-56.95 -213.85,-170.83 0,-169.1 172.9,-253.48 518.69,-253.48 197.3,0 333.38,27.78 408.66,83.7 75.7,55.56 113.33,157.44 113.33,305.27l0 418.13c0,71.35 23.58,107.02 71.15,107.02 56.67,0 89.76,-70.66 99.68,-211.98l37.23 2.06c-6.62,121.09 -33.92,204.09 -82.31,249.03 -47.57,45.28 -126.16,67.91 -235.77,67.91 -198.13,0 -312.29,-50.76 -342.07,-152.29 -21.51,52.48 -53.77,90.9 -97.2,115.59 -42.6,24.36 -105.48,36.7 -188.2,36.7 -244.87,0 -367.3,-83 -367.3,-249.36 0,-97.08 46.74,-163.62 139.8,-200.32 93.9,-36.71 237.42,-54.88 431,-54.88zm-99.27 253.48c0,71.35 4.55,117.31 13.24,137.89 9.51,20.58 26.89,30.87 52.12,30.87 26.05,0 50.04,-17.49 71.97,-52.48 22.74,-34.99 33.91,-83.35 33.91,-145.09l0 -191.4 -17.37 0c-102.58,0 -153.87,62.42 -153.87,187.28l0 32.93zm2293.15 230.5l-565.84 0 -27.3 -150.24c-26.06,54.89 -65.35,97.08 -117.47,126.58 -52.12,29.49 -129.46,44.24 -232.04,44.24 -256.87,0 -385.09,-114.56 -385.09,-343.69l0 -619.48 -139.39 0 0 -37.05 601.41 0 0 705.92c0,82.32 6.62,136.52 20.27,162.59 14.48,26.41 42.6,39.44 84.38,39.44 42.6,0 80.24,-21.26 113.33,-64.14 33.09,-42.53 49.64,-101.53 49.64,-177.34l0 -629.42 -113.75 0 0 -37.05 575.36 0 0 942.6 136.49 0 0 37.04zm173.73 -294.3l0 -648.29 -136.91 0 0 -37.05 136.91 0 0 -265.49 462.02 -94.32 0 359.81 322.21 0 0 37.05 -322.21 0 0 693.22c0,64.83 7.44,112.17 22.75,142.35 15.71,30.19 48.39,45.28 98.44,45.28 49.64,0 93.07,-20.58 129.88,-61.74 37.64,-41.5 62.46,-97.76 73.62,-169.11l42.2 4.81c-13.24,94.32 -49.64,169.44 -109.62,225.01 -59.14,55.57 -157.59,83.35 -294.91,83.35 -137.33,0 -242.39,-22.63 -315.19,-67.91 -72.8,-44.94 -109.19,-127.26 -109.19,-246.97zm816.09 -648.29l0 -37.05 720.12 0 0 37.05 -134.02 0 270.93 683.28 287.47 -683.28 -166.28 0 0 -37.05 349.93 0 0 37.05 -124.09 0 -464.09 1109.3c-54.59,128.97 -115.81,219.18 -183.65,270.29 -67.83,51.79 -150.56,77.52 -248.59,77.52 -97.2,0 -174.14,-18.52 -230.8,-55.91 -55.84,-36.71 -83.97,-84.04 -83.97,-141.66 0,-57.63 18.2,-101.54 54.6,-131.38 35.99,-30.18 83.97,-45.28 143.94,-45.28 137.33,0 205.99,47.34 205.99,141.67 0,20.92 -4.97,45.62 -14.89,74.43l-86.86 0c-13.24,31.22 -14.89,57.29 -5.38,77.86 10.34,20.58 32.68,30.87 67.42,30.87 67.84,0 128.23,-27.78 181.17,-83.35 52.53,-55.56 102.99,-140.29 151.39,-254.17l54.6 -127.6 -218.4 0 -424.79 -942.59 -101.75 0zm-8070.29 80.26c39.3,-25.38 68.25,-52.13 86.45,-80.26 18.2,-28.13 27.3,-59.68 27.3,-94.33 0,-49.74 -14.48,-88.15 -43.43,-115.59 -29.37,-27.44 -69.91,-41.16 -122.44,-41.16 -43.84,0 -79.41,10.97 -106.3,32.58 -26.88,21.61 -40.53,50.08 -40.53,84.72 0,39.45 15.3,75.81 45.5,108.74 30.19,32.58 81.48,67.92 153.45,105.3zm210.54 597.18c-54.19,-81.29 -115.82,-155.38 -185.72,-222.27 -69.9,-66.88 -148.49,-127.6 -235.77,-181.79 -62.46,36.01 -107.96,73.75 -136.91,112.85 -29.37,39.45 -43.84,82.67 -43.84,130.34 0,80.27 30.61,148.18 91.82,203.41 60.8,55.22 136.09,83.01 225.84,83.01 52.53,0 102.17,-10.29 148.91,-31.22 46.74,-20.92 92.24,-52.13 135.67,-94.33zm54.6 100.51c-74.04,62.77 -154.7,110.1 -241.56,142 -86.86,31.9 -179.1,47.68 -277.13,47.68 -139.39,0 -252.32,-33.27 -337.93,-99.47 -85.63,-66.2 -128.65,-153.33 -128.65,-261.38 0,-84.38 34.75,-159.15 104.24,-223.98 69.49,-64.83 175.38,-121.09 317.67,-168.76 -66.18,-52.82 -114.17,-100.85 -143.53,-144.07 -29.37,-43.22 -44.26,-86.43 -44.26,-129.31 0,-79.92 40.53,-146.47 121.19,-199.98 80.66,-53.51 183.24,-80.26 307.74,-80.26 119.54,0 213.43,20.92 281.68,62.77 68.25,41.85 102.58,99.13 102.58,172.19 0,48.37 -18.61,93.3 -55.43,135.15 -36.81,41.84 -92.65,80.95 -167.51,117.31 73.21,50.76 137.73,102.21 193.57,154.01 55.84,51.79 105.89,107.02 149.32,165.33 71.56,-90.9 123.26,-163.27 154.29,-217.13 31.02,-53.51 46.73,-96.38 46.73,-128.63 0,-11.32 -8.27,-19.2 -24.4,-24.01 -16.13,-4.46 -44.26,-6.85 -84.79,-6.85l-30.2 0 2.48 -90.56 511.25 0 2.48 86.44c-58.32,0 -104.24,4.8 -138.57,14.41 -34.33,9.94 -62.45,25.38 -84.37,46.99 -0.83,0.68 -29.37,45.62 -86.04,134.46 -56.67,89.18 -120.78,177.68 -192.75,265.49l64.53 92.27c47.56,71 86.03,118.34 116.22,141.66 29.79,23.67 62.46,35.33 98.04,35.33 19.44,0 41.36,-3.77 66.17,-10.98 24.41,-7.54 52.95,-18.86 85.21,-34.3l46.33 76.5c-56.67,40.81 -114.99,71 -175.38,91.24 -59.98,20.23 -123.26,30.18 -189.44,30.18 -72.8,0 -137.74,-14.75 -194.41,-44.25 -57.08,-29.5 -115.4,-78.55 -175.37,-147.49z"/><line fill="none" fill-rule="nonzero" stroke="currentColor" stroke-width="500" stroke-miterlimit="22.9256" x1="107.41" y1="13538.42" x2="29591.53" y2="13538.42"/></g>
                                        </svg>
                                        <h1 className="text-4xl font-bold text-blue-600 tracking-tight mt-1">
                                            Satış Paneli
                                        </h1>
                                    </div>
                                    <button className="md:hidden absolute -top-2 right-0 text-gray-500 hover:text-gray-800" onClick={() => setSidebarOpen(false)}>
                                        <Icon name="x" size={24} />
                                    </button>
                                </div>
                            <nav className="space-y-3">
                                <NavItem onClick={() => handleViewChange('dashboard')} isActive={view === 'dashboard'}><Icon name="layout-dashboard" size={20}/><span>Gösterge Paneli</span></NavItem>
                                <NavItem onClick={() => handleViewChange('sales')} isActive={view === 'sales'}><Icon name="dollar-sign" size={20}/><span>Satışlar</span></NavItem>
                                <NavItem onClick={() => handleViewChange('personnel')} isActive={view === 'personnel'}><Icon name="users" size={20}/><span>Personel</span></NavItem>
                                <NavItem onClick={() => handleViewChange('items')} isActive={view === 'items'}><Icon name="package" size={20}/><span>Ürünler & Hizmetler</span></NavItem>
                            </nav>
                        </div>
                        <div className="text-center text-xs text-gray-400">
                            <p>Proje ID:</p><p className="break-words font-mono text-gray-500">{appId}</p>
                            <p className="mt-2 font-semibold text-green-600">USD/TRY: {usdToTryRate || 'Yükleniyor...'}</p>
                        </div>
                    </aside>

                    {/* Main content */}
                    <div className="flex-1 flex flex-col">
                         {/* Header with hamburger menu for mobile */}
                        <header className="md:hidden sticky top-0 bg-white/80 backdrop-blur-sm z-10 flex justify-between items-center p-4 shadow-sm">
                            <button onClick={() => setSidebarOpen(true)} className="text-gray-700">
                                <Icon name="menu" size={24} />
                            </button>
                            <h2 className="font-bold text-lg text-blue-600">
                                {view === 'personnel' && selectedPersonnelId ? 'Personel Detayı' : view.charAt(0).toUpperCase() + view.slice(1)}
                            </h2>
                            <div className="w-6"></div> {/* Spacer */}
                        </header>
                        <main className="flex-1 p-4 md:p-8 overflow-y-auto">
                            {renderView()}
                        </main>
                    </div>

                    {/* Modals */}
                    <ExcelImportModal isOpen={isImportModalOpen} onClose={() => setImportModalOpen(false)} onImport={handleBulkImport} />
                    <Modal isOpen={isSaleModalOpen} onClose={() => { setSaleModalOpen(false); setEditingSale(null); }} title={editingSale ? "Satış Düzenle" : "Yeni Satış Ekle"}>
                        <SaleForm sale={editingSale} items={items} personnel={personnel} onSave={(data) => handleSave('sales', data, editingSale?.id)} onCancel={() => { setSaleModalOpen(false); setEditingSale(null); }} usdToTryRate={usdToTryRate} />
                    </Modal>
                    <Modal isOpen={isItemModalOpen} onClose={() => setItemModalOpen(false)} title={editingItem ? "Düzenle" : "Yeni Ürün/Hizmet Ekle"}><ItemForm item={editingItem} onSave={(data) => handleSave('items', data, editingItem?.id)} onCancel={() => { setItemModalOpen(false); setEditingItem(null); }} /></Modal>
                    <Modal isOpen={isPersonnelModalOpen} onClose={() => setPersonnelModalOpen(false)} title={editingPersonnel ? "Personel Düzenle" : "Yeni Personel Ekle"}><PersonnelForm person={editingPersonnel} onSave={(data) => handleSave('personnel', data, editingPersonnel?.id)} onCancel={() => { setEditingPersonnel(null); setPersonnelModalOpen(false);}} /></Modal>
                     <Modal isOpen={isDeleteConfirmOpen} onClose={() => setDeleteConfirmOpen(false)} title="Kaydı Sil">
                        <div className="space-y-4">
                            <p>Bu kaydı kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
                            <div className="flex justify-end space-x-3 pt-4">
                                <Button onClick={() => setDeleteConfirmOpen(false)} className="bg-gray-300 hover:bg-gray-400 text-gray-800">İptal</Button>
                                <Button onClick={handleDelete} className="bg-red-600 hover:bg-red-700 text-white">Sil</Button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
```
